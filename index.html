<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام جرد أصناف المطاعم - شركة نايف للأغذية</title>
    <link rel="icon" href="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" type="image/jpeg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #3B82F6;
            --background: #EFF6FF;
            --text: #1F2937;
            --card-bg: #FFFFFF;
            --shadow: rgba(30, 58, 138, 0.1);
            --accent-red: #DC2626;
            --accent-green: #10B981;
            --accent-orange: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 60px;
            margin-left: 15px;
        }

        .logo h1 {
            font-size: 24px;
        }

        .company-name h2 {
            font-size: 20px;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .nav-tab.active {
            background-color: var(--primary);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background-color: rgba(30, 58, 138, 0.1);
        }

        .section {
            display: none;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .section.active {
            display: block;
        }

        .file-upload {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            background-color: rgba(30, 58, 138, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .file-upload-small {
            width: 300px;
            margin: 0 auto;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .file-upload label:hover {
            background-color: #1e40af;
        }

        .upload-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px var(--shadow);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .inventory-table th, .inventory-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .inventory-table th {
            background-color: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .inventory-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .inventory-table tr:hover {
            background-color: #f1f1f1;
        }

        .inventory-table td:nth-child(2) {
            font-size: 16px !important;
            font-weight: 600;
        }

        /* زيادة حجم الخط وعمل Bold للرصيد بالوحدة الصغرى */
        .inventory-table td:nth-child(6) {
            font-size: 18px !important;
            font-weight: bold !important;
            color: var(--primary);
        }

        /* تكبير الخط في الجداول المخصصة للجرد */
        .actual-count-input {
            width: 90px;
            padding: 6px;
            font-size: 18px !important;
            font-weight: bold !important;
            text-align: center;
            border: 2px solid var(--primary);
            border-radius: 4px;
        }

        /* تكبير الخط في أعمدة الجرد */
        .count-cell {
            font-size: 18px !important;
            font-weight: bold !important;
        }

        .difference-cell {
            font-size: 18px !important;
            font-weight: bold !important;
        }

        /* تلوين العجز باللون الأحمر */
        .difference-negative {
            color: var(--accent-red) !important;
        }

        .difference-positive {
            color: var(--accent-green) !important;
        }

        /* إضافة كلمة عجز/زيادة */
        .difference-text {
            font-size: 12px !important;
            font-weight: normal !important;
            margin-right: 5px;
        }

        /* الخلية المجمعة للأصناف المتشابهة */
        .combined-difference-cell {
            font-size: 22px !important;
            font-weight: bold !important;
            background-color: #f0f9ff;
            border: 2px solid var(--secondary) !important;
            vertical-align: middle;
            height: 60px;
            min-width: 100px;
        }

        .combined-difference-negative {
            color: var(--accent-red) !important;
            background-color: #fef2f2;
        }

        .combined-difference-positive {
            color: var(--accent-green) !important;
            background-color: #f0fdf4;
        }

        .combined-difference-zero {
            color: var(--primary) !important;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1e40af;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2563eb;
        }

        .btn-green {
            background-color: var(--accent-green);
            color: white;
        }

        .btn-green:hover {
            background-color: #059669;
        }

        .btn-orange {
            background-color: var(--accent-orange);
            color: white;
        }

        .btn-orange:hover {
            background-color: #D97706;
        }

        .btn-red {
            background-color: var(--accent-red);
            color: white;
        }

        .btn-red:hover {
            background-color: #b91c1c;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .inventory-category {
            margin-bottom: 20px;
        }

        .category-title {
            background-color: var(--primary);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .category-title-red {
            background-color: var(--accent-red);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .category-title-green {
            background-color: var(--accent-green);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .category-title-orange {
            background-color: var(--accent-orange);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .search-filter {
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 16px;
        }

        .restaurant-info {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px var(--shadow);
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .info-label {
            font-weight: bold;
            width: 120px;
            font-size: 14px;
            color: var(--primary);
        }

        .info-value {
            flex: 1;
        }

        .info-value input, .info-value select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .restaurant-autocomplete {
            position: relative;
            width: 100%;
        }

        .restaurant-search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .restaurant-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #EFF6FF;
            border: 2px solid var(--primary);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .restaurant-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.2s;
        }

        .restaurant-suggestion:hover {
            background-color: #DBEAFE;
        }

        .restaurant-suggestion:last-child {
            border-bottom: none;
        }

        .manager-info {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .manager-box {
            flex: 1;
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--primary);
        }

        .manager-label {
            font-size: 11px;
            color: #666;
        }

        .manager-name {
            font-weight: bold;
            margin-top: 3px;
            font-size: 13px;
            color: var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 1000;
            display: none;
        }

        .group-total {
            background-color: #DBEAFE;
            font-weight: bold;
        }

        .movement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .modal-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
        }

        .whatsapp-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .restaurant-search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .current-stock {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background-color: #EFF6FF;
            border-radius: 4px;
            border: 1px solid var(--primary);
        }

        .item-select {
            transform: scale(1.5);
            cursor: pointer;
        }

        /* قالب PDF المخفي */
        .pdf-template {
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 794px;
            height: 1123px;
            background: white;
            padding: 10px;
            box-sizing: border-box;
            z-index: -1000;
            font-size: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
        }

        /* توقيع المطور */
        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10.5px 17.5px;
            border-radius: 8.5px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .signature-card:hover { 
            transform: scale(1.05); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.4); 
        }

        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-15px); } 
            100% { transform: translateY(0px); } 
        }

        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #60A5FA, var(--primary));
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }

        @keyframes borderGlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        .signature-card .name { 
            font-size: 0.95rem; 
            font-weight: 700; 
            margin-bottom: 5px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }

        .signature-card .title { 
            font-size: 0.7rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }

        /* إضافة إرفاق ملف للواتساب */
        .file-attachment {
            margin-top: 15px;
            padding: 10px;
            border: 2px dashed var(--secondary);
            border-radius: 6px;
            text-align: center;
            background-color: rgba(59, 130, 246, 0.05);
        }

        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
            } 
            .signature-card:hover { 
                transform: none; 
            } 
        }

        @media print {
            .signature-card {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-bottom: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .inventory-table {
                font-size: 10px;
            }
            
            .inventory-table th, .inventory-table td {
                padding: 4px;
            }
            
            .actual-count-input {
                width: 60px;
                font-size: 14px !important;
            }
            
            .inventory-table td:nth-child(2) {
                font-size: 14px !important;
            }
            
            .inventory-table td:nth-child(6) {
                font-size: 16px !important;
            }
            
            .file-upload-small {
                width: 100%;
            }
            
            .upload-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .combined-difference-cell {
                font-size: 16px !important;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <img src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار شركة نايف للأغذية">
                    <div>
                        <h1>نظام جرد أصناف المطاعم</h1>
                        <div class="company-name">
                            <h2>شركة نايف للأغذية</h2>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" data-target="upload-section">تحميل البيانات</div>
            <div class="nav-tab" data-target="meat-section">جرد اللحوم</div>
            <div class="nav-tab" data-target="veg-section">جرد الخضروات</div>
            <div class="nav-tab" data-target="appetizers-section">جرد المقبلات</div>
            <div class="nav-tab" data-target="settings-section">الإعدادات</div>
        </div>

        <!-- قسم تحميل البيانات -->
        <section id="upload-section" class="section active">
            <h2 style="color: var(--primary); margin-bottom: 20px;">تحميل بيانات الأصناف من ملف Excel</h2>
            <div class="file-upload" style="padding: 25px; width: 800px; margin: 0 auto;">
    <div style="display: flex; gap: 20px; align-items: center; justify-content: center; width: 100%;">
        <div>
            <input type="file" id="excel-file" accept=".xlsx, .xls">
            <label for="excel-file" style="margin: 0; padding: 12px 25px; font-size: 18px;">اختر ملف Excel  (Spot Stock Take)</label>
        </div>
        <button class="btn" id="load-default-items" style="background-color: var(--accent-red); padding: 12px 25px; font-size: 18px;">
            تحميل الأصناف الأساسية
        </button>
    </div>
    <p style="margin-top: 15px; color: var(--primary); font-weight: 200; font-size: 12px;">Yasser Elkhateeb</p>
</div>

            <div class="stats-cards">
                <div class="stat-card">
                    <h3>إجمالي الأصناف</h3>
                    <div class="value" id="total-items">0</div>
                </div>
                <div class="stat-card">
                    <h3>الأصناف التي تحتاج طلب</h3>
                    <div class="value" id="low-stock-items">0</div>
                </div>
                <div class="stat-card">
                    <h3>الأصناف المختارة للجرد</h3>
                    <div class="value" id="selected-items">0</div>
                </div>
            </div>

            <div class="search-filter">
                <input type="text" class="search-box" id="search-items" placeholder="ابحث عن صنف...">
            </div>

            <div class="inventory-table-container">
                <table class="inventory-table" id="items-table">
                    <thead>
                        <tr>
                            <th>RM Code</th>
                            <th>اسم الصنف</th>
                            <th>الوحدة</th>
                            <th>الرصيد الحالي</th>
                            <th>الوحدة الصغرى</th>
                            <th>الرصيد بالوحدة الصغرى</th>
                            <th>اختيار للجرد</th>
                            <th>الحركة</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- قسم جرد اللحوم -->
        <section id="meat-section" class="section">
            <h2 style="color: var(--primary); margin-bottom: 20px;">جرد أصناف اللحوم</h2>
            <div class="restaurant-info">
                <div class="info-row">
                    <div class="info-label">اسم المطعم:</div>
                    <div class="info-value">
                        <div class="restaurant-autocomplete">
                            <input type="text" class="restaurant-search-input" id="meat-restaurant-search" placeholder="اكتب اسم المطعم...">
                            <div class="restaurant-suggestions" id="meat-restaurant-suggestions"></div>
                        </div>
                        <input type="hidden" id="meat-restaurant-name">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">مسئول المطعم:</div>
                    <div class="info-value">
                        <input type="text" id="meat-responsible" placeholder="اسم المسئول">
                    </div>
                </div>
                <div class="manager-info">
                    <div class="manager-box">
                        <div class="manager-label">مدير المنطقة</div>
                        <div class="manager-name" id="meat-area-manager">-</div>
                    </div>
                    <div class="manager-box">
                        <div class="manager-label">مدير التشغيل</div>
                        <div class="manager-name" id="meat-operations-manager">-</div>
                    </div>
                </div>
            </div>

            <div id="meat-inventory-container">
                <!-- سيتم ملؤها بالأصناف المختارة للجرد -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="generate-meat-pdf">
                    تصدير إلى PDF
                </button>
                <button class="btn btn-primary" id="generate-meat-excel">
                    تصدير إلى Excel
                </button>
                <button class="btn btn-secondary" id="send-meat-whatsapp">
                    إرسال إلى واتساب
                </button>
            </div>
        </section>

        <!-- قسم جرد الخضروات -->
        <section id="veg-section" class="section">
            <h2 style="color: var(--primary); margin-bottom: 20px;">جرد أصناف الخضروات</h2>
            <div class="restaurant-info">
                <div class="info-row">
                    <div class="info-label">اسم المطعم:</div>
                    <div class="info-value">
                        <div class="restaurant-autocomplete">
                            <input type="text" class="restaurant-search-input" id="veg-restaurant-search" placeholder="اكتب اسم المطعم...">
                            <div class="restaurant-suggestions" id="veg-restaurant-suggestions"></div>
                        </div>
                        <input type="hidden" id="veg-restaurant-name">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">مسئول المطعم:</div>
                    <div class="info-value">
                        <input type="text" id="veg-responsible" placeholder="اسم المسئول">
                    </div>
                </div>
                <div class="manager-info">
                    <div class="manager-box">
                        <div class="manager-label">مدير المنطقة</div>
                        <div class="manager-name" id="veg-area-manager">-</div>
                    </div>
                    <div class="manager-box">
                        <div class="manager-label">مدير التشغيل</div>
                        <div class="manager-name" id="veg-operations-manager">-</div>
                    </div>
                </div>
            </div>

            <div id="veg-inventory-container">
                <!-- سيتم ملؤها بالأصناف المختارة للجرد -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="generate-veg-pdf">
                    تصدير إلى PDF
                </button>
                <button class="btn btn-primary" id="generate-veg-excel">
                    تصدير إلى Excel
                </button>
                <button class="btn btn-secondary" id="send-veg-whatsapp">
                    إرسال إلى واتساب
                </button>
            </div>
        </section>

        <!-- قسم جرد المقبلات -->
        <section id="appetizers-section" class="section">
            <h2 style="color: var(--primary); margin-bottom: 20px;">جرد أصناف المقبلات</h2>
            <div class="restaurant-info">
                <div class="info-row">
                    <div class="info-label">اسم المطعم:</div>
                    <div class="info-value">
                        <div class="restaurant-autocomplete">
                            <input type="text" class="restaurant-search-input" id="appetizers-restaurant-search" placeholder="اكتب اسم المطعم...">
                            <div class="restaurant-suggestions" id="appetizers-restaurant-suggestions"></div>
                        </div>
                        <input type="hidden" id="appetizers-restaurant-name">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">مسئول المطعم:</div>
                    <div class="info-value">
                        <input type="text" id="appetizers-responsible" placeholder="اسم المسئول">
                    </div>
                </div>
                <div class="manager-info">
                    <div class="manager-box">
                        <div class="manager-label">مدير المنطقة</div>
                        <div class="manager-name" id="appetizers-area-manager">-</div>
                    </div>
                    <div class="manager-box">
                        <div class="manager-label">مدير التشغيل</div>
                        <div class="manager-name" id="appetizers-operations-manager">-</div>
                    </div>
                </div>
            </div>

            <div id="appetizers-inventory-container">
                <!-- سيتم ملؤها بالأصناف المختارة للجرد -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="generate-appetizers-pdf">
                    تصدير إلى PDF
                </button>
                <button class="btn btn-primary" id="generate-appetizers-excel">
                    تصدير إلى Excel
                </button>
                <button class="btn btn-secondary" id="send-appetizers-whatsapp">
                    إرسال إلى واتساب
                </button>
            </div>
        </section>

        <!-- قسم الإعدادات -->
        <section id="settings-section" class="section">
            <h2 style="color: var(--primary); margin-bottom: 20px;">إعدادات النظام</h2>
            
            <div class="restaurant-info">
                <h3 style="color: var(--primary); margin-bottom: 15px;">إدارة المطاعم والمدراء</h3>
                
                <div class="info-row">
                    <div class="info-label">المطاعم:</div>
                    <div class="info-value">
                        <button class="btn btn-primary" id="add-restaurant">إضافة مطعم</button>
                        <button class="btn btn-secondary" id="edit-restaurant">تعديل مطعم</button>
                        <button class="btn btn-red" id="delete-restaurant">حذف مطعم</button>
                    </div>
                </div>
            </div>

            <div class="inventory-table-container">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>المطعم</th>
                            <th>مدير المنطقة</th>
                            <th>مدير التشغيل</th>
                        </tr>
                    </thead>
                    <tbody id="restaurants-table-body">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- نافذة عرض الحركة -->
        <div class="movement-modal" id="movement-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="movement-modal-title">حركة الصنف</div>
                    <button class="close-modal" id="close-movement-modal">&times;</button>
                </div>
                <div id="movement-modal-content">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
        </div>

        <!-- نافذة إدخال رقم الواتساب -->
        <div class="whatsapp-modal" id="whatsapp-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">إرسال إلى واتساب</div>
                    <button class="close-modal" id="close-whatsapp-modal">&times;</button>
                </div>
                <div>
                    <div class="info-row">
                        <div class="info-label">رقم الهاتف:</div>
                        <div class="info-value">
                            <input type="text" id="whatsapp-number" placeholder="+965 67011143" value="+96567011143">
                        </div>
                    </div>
                    
                    <!-- إضافة خيار إرفاق ملف -->
                    <div class="file-attachment">
                        <div style="margin-bottom: 8px; font-weight: bold; color: var(--primary);">
                            إرفاق ملف (اختياري)
                        </div>
                        <input type="file" id="whatsapp-attachment" style="display: none;" accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        <label for="whatsapp-attachment" class="btn btn-small btn-secondary" style="display: inline-block; margin-bottom: 8px;">
                            اختر ملف
                        </label>
                        <div id="attachment-name" style="font-size: 12px; color: #666;">
                            لم يتم اختيار ملف
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="confirm-whatsapp-send">إرسال</button>
                        <button class="btn btn-secondary" id="cancel-whatsapp-send">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة البحث عن المطعم -->
        <div class="restaurant-search-modal" id="restaurant-search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">البحث عن المطعم</div>
                    <button class="close-modal" id="close-restaurant-search-modal">&times;</button>
                </div>
                <div>
                    <div class="search-filter">
                        <input type="text" class="search-box" id="restaurant-search-box" placeholder="ابحث عن مطعم...">
                    </div>
                    <div id="restaurant-search-results" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                        <!-- سيتم ملؤها بنتائج البحث -->
                    </div>
                </div>
            </div>
        </div>

        <div class="notification" id="notification">
            تم حفظ البيانات بنجاح!
        </div>
    </div>

    <!-- قالب PDF المخفي -->
    <div id="pdf-template" class="pdf-template">
        <div class="pdf-header" style="text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary);">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                <img src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار شركة نايف للأغذية" 
                     style="width: 60px; height: 60px; margin-left: 15px;">
                <div>
                    <h1 style="color: var(--primary); margin: 0; font-size: 22px; font-weight: bold;">
                        شركة نايف للأغذية
                    </h1>
                    <h2 style="color: #333; margin: 5px 0 0 0; font-size: 18px;">
                        نظام جرد أصناف المطاعم
                    </h2>
                </div>
            </div>
        </div>
        
        <div id="pdf-restaurant-info" style="margin-bottom: 15px; padding: 10px; background: #EFF6FF; border-radius: 4px; font-size: 12px; border: 1px solid var(--primary);">
            <!-- سيتم ملؤه بالبيانات -->
        </div>
        
        <div id="pdf-content" style="font-size: 11px;">
            <!-- سيتم ملؤه بمحتوى الجرد -->
        </div>
        
        <div id="pdf-footer" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 10px; color: #666;">
            <div style="margin-bottom: 5px;">تم إنشاء هذا التقرير بواسطة نظام جرد أصناف المطاعم</div>
            <div>تاريخ الطباعة: <span id="pdf-print-date"></span></div>
        </div>
    </div>

    <!-- HTML لاستخدامه في أي مكان -->
    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 67011143</div>
    </div>

    <script>
        // بيانات التطبيق
        let inventoryData = [];
        let selectedItems = [];
        let currentWhatsappType = ''; // 'meat' أو 'veg' أو 'appetizers'
        let whatsappAttachmentFile = null;
        
        // بيانات الأصناف الأساسية من ملف الاصناف الاساسية.xlsx
        const defaultItems = [
            // لحوم
            { code: "K1035", name: "Chicken Big Fillet  ( بيج فيلية)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1036", name: "Chicken Big Fillet Spicy  ( بيج فيلية فلفل)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1008", name: "Chicken Fillet  ( فيليه عادي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1009", name: "Chicken Fillet Spicy  ( فيليه فلفل)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1016", name: "Ch.Finger Fillet Spicy  ( اصابع فيليه فلفل)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1015", name: "Chicken Finger Fillet  ( اصابع فيليه)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1049", name: "Grilled Chicken Fillet  فيليه مشوي", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1020", name: "Royal Grilled Chicken (دجاج شواية ملكي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1006", name: "Chicken Tikka ( دجاج تكا عادي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1004", name: "Chicken Tikka Brest ( تكا صدور)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1005", name: "Chicken Tikka Thigh  (تكا فخذ)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1017", name: "Grilled Quils (فري مشوي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1011", name: "Rooster Junior  ( فروج نايف)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1014", name: "Bint Al-Deek  ( بنت الديك)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1012", name: "Chicken Fried  ( دجاج فرايد عادي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1013", name: "Chicken Fried Spicy  (دجاج فرايد فلفل)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "A1007", name: "Beef Burger Big(برجر لحم كبير)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "A1008", name: "Beef Burger Small(برجر لحم صغير)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "A1004", name: "Chicken Burger Small  ( برجر دجاج صغير)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1070", name: "Fresh Burger Chickens برجر دجاج طازج", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "كيلو", smallestUnitQty: 0 },
            { code: "K1071", name: "Chicken Small Wings Nor  جناح صغير عادي", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1072", name: "Chicken Small Wings Spicy  جناح صغير فلفل", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1010", name: "Chicken Wings  جناح متبل", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1075", name: "Fillet Pizza Grill / فيلية بيتزا مشوي", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1007", name: "Chicken Drum Stick ( درام ستيك)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1039", name: "Drumstic whole Fried  ( وصلة دجاج عادي)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K1040", name: "Drumstick whole Fried spicy  ( وصلة دجاج فلفل)", group: "meat", vendorUOM: "KG", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            
            // مقبلات
            { code: "K2035", name: "Fattoush Salad Big  ( سلطة فتوش كبيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2014", name: "Fattoush Salad Small  (سلطة فتوش صغيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2005", name: "Cole Slaw Big  (كول سلو كبير)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2006", name: "Cole Slaw Small  ( كول سلو صغير)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2001", name: "Hummus  ( حمص)", group: "appetizers", vendorUOM: "كيلو", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K2020", name: "Hummus large ( ماعون حمص كبير)", group: "appetizers", vendorUOM: "كيلو", stockQty: 0, uuom: "جرام", smallestUnitQty: 0 },
            { code: "K2009", name: "Laban Naif Small (لبن نايف صغير )", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2008", name: "Rice&Milk Pudding ( أرز بالحليب)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2033", name: "Rocca Salad Big  ( سلطة جرجيركبيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2016", name: "Rocca Salad Small  ( سلطة الجرجيرصغيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2034", name: "Taboulla Salad Big  ( سلطة تبولة كبيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2015", name: "Taboulla Salad Small  ( سلطة تبوله صغيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2036", name: "Vegitable Salad Big  ( سلطة خضراء كبيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 },
            { code: "K2012", name: "Vegitable Salad Small  ( سلطة خضراء صغيرة)", group: "appetizers", vendorUOM: "علبة", stockQty: 0, uuom: "علبة", smallestUnitQty: 0 }
        ];
        
        // بيانات المطاعم والمدراء المحدثة من ملف Naif Restaurants with Managers Name.xlsx
        const restaurants = [
            { name: "اسواق القرين", areaManager: "مرتضى", operationsManager: "طارق بيومي" },
            { name: "الجابرية بنت الديك", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "الجابرية تكا و فرايد", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "الجهراء - ليالي الشرق", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "الجهراء - مجمع مكة", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "الجهراء الزويخ", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "الجهراء الصناعية", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "الخيران أوتليت", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "الخيران أويا", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "الخيول", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "الدسمة وبنيد القار", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "الرحاب", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "الرقة", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "الرقعي", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "الري", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "السندباد", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "الشرق", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "الشويخ واره", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "الصليبية", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "الضباعية", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "العارضية الحرفية", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "الفحاحيل", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "الفروانية", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "الفروانية فرع 2", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "الفنطاس", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "الفيحاء", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "القادسية", areaManager: "وليد", operationsManager: "طارق بيومi" },
            { name: "المطار", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "المنقف", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "النافورة", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "أبوحليفة", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "جمعية الزهراء التعاونية", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "جمعية الشهداء", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "جمعية الصليبية", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "جمعية العدان والقصور", areaManager: "مرتضى", operationsManager: "طارق بيومي" },
            { name: "جمعية القيروان", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "جمعية الوفرة", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "جمعية أبو فطيرة", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "جمعية مدينة جابر الأحمد", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "حولي الترفيهي", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "خيطان العصيمي", areaManager: "مرتضى", operationsManager: "طارق بيومي" },
            { name: "سلوى", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "سوق الجليب", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "سيد ياسين", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "شارع البحرين", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "شرق الاحمدي", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "صباح السالم", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "صباح السالم - العرين", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "غرب أبو فطيرة الحرفية", areaManager: "مرتضى", operationsManager: "طارق بيومي" },
            { name: "كبد", areaManager: "مختار", operationsManager: "طارق بيومي" },
            { name: "مارينا مول - عالم المارينا", areaManager: "طارق", operationsManager: "هاني عبدالله" },
            { name: "مجمع الافنيوز", areaManager: "مرتضى", operationsManager: "طارق بيومي" },
            { name: "مجمع الكوت", areaManager: "عماد", operationsManager: "هاني عبدالله" },
            { name: "مدينة سعد العبد الله", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "مدينة صباح الاحمد", areaManager: "حجازي", operationsManager: "هاني عبدالله" },
            { name: "مشرف", areaManager: "انور", operationsManager: "هاني عبدالله" },
            { name: "مول 360", areaManager: "وليد", operationsManager: "طارق بيومي" },
            { name: "نادي الصليبخات", areaManager: "ثروت", operationsManager: "طارق بيومي" },
            { name: "هدية", areaManager: "حجازي", operationsManager: "هاني عبدالله" }
        ];
        
        // جدول تحويل الوحدات من Excel
        const unitConversionMap = {
            // الكيلوغرامات
            "KILO": 1000,
            "KILO GRAM": 1000,
            "KG": 1000,
            "كجم": 1000,
            "كيلو": 1000,
            
            // النصف كيلو
            "1/2 KILO": 500,
            "500 GM": 500,
            "500 G": 500,
            "500 جرام": 500,
            "نصف كيلو": 500,
            
            // الجرامات
            "GRM": 1,
            "GM": 1,
            "G": 1,
            "جرام": 1,
            
            // المليلترات
            "ML": 1,
            "مليلتر": 1,
            
            // اللترات
            "LTR": 1000,
            "L": 1000,
            "لتر": 1000,
            
            // الجالونات
            "GALLON": 3785.41,
            "GAL": 3785.41,
            "جالون": 3785.41,
            
            // القطع
            "PCS": 1,
            "PC": 1,
            "قطعة": 1,
            "حبة": 1,
            
            // الرولات
            "ROLL": 1,
            "رول": 1,
            
            // الأكياس
            "BAG": 1,
            "كيس": 1,
            
            // العلب
            "TIN": 1,
            "علبة": 1,
            
            // الزجاجات
            "BOTTLE": 1,
            "زجاجة": 1,
            
            // الكراتين
            "CARTON": 1,
            "كرتون": 1,
            
            // الرزم
            "PACKET": 1,
            "رزمة": 1,
            
            // الدزنة
            "DOZEN": 12,
            "دزنة": 12,
            
            // الرطل
            "LBS": 453.592,
            "رطل": 453.592
        };
        
        // تحديد المجموعات بناءً على Group من ملف Excel (محدث لفصل المقبلات)
        function getItemGroup(item) {
            if (item.group && item.group.includes('MEAT')) {
                return 'meat';
            } else if (item.group && (item.group.includes('VEG') || item.group.includes('SALAD'))) {
                return 'vegetables';
            } else if (item.group && item.group.includes('APPETIZERS')) {
                return 'appetizers';
            } else if (item.name && (item.name.includes('لحم') || item.name.includes('دجاج') || item.name.includes('برجر') || item.name.includes('فيليه') || item.name.includes('شاورما') || item.name.includes('كباب') || item.name.includes('تيكا') || item.name.includes('فرايد'))) {
                return 'meat';
            } else if (item.name && (item.name.includes('خض') || item.name.includes('خيار') || item.name.includes('طماطم') || item.name.includes('بصل') || item.name.includes('جزر') || item.name.includes('فلفل') || item.name.includes('بقدونس') || item.name.includes('ليمون') || item.name.includes('برتقال') || item.name.includes('خس'))) {
                return 'vegetables';
            } else if (item.name && (item.name.includes('حمص') || item.name.includes('متبل') || item.name.includes('فتوش') || item.name.includes('تبولة') || item.name.includes('سلطة') || item.name.includes('جرجير') || item.name.includes('كول سلو') || item.name.includes('لبن') || item.name.includes('لبنة') || item.name.includes('بيض') || item.name.includes('أرز') || item.name.includes('بوري') || item.name.includes('صوص') || item.name.includes('صلصة') || item.name.includes('مايونيز') || item.name.includes('كاتشب') || item.name.includes('بهارات') || item.name.includes('ملح') || item.name.includes('سكر') || item.name.includes('زيت'))) {
                return 'appetizers';
            }
            return 'other';
        }

        // دالة محسنة لتحويل الوحدات باستخدام جدول Excel
        function convertToSmallestUnit(quantity, vendorUOM, uuom) {
            if (!vendorUOM || !quantity) return Math.round(quantity);
            
            const vendorUOMUpper = vendorUOM.toUpperCase();
            let multiplier = 1;
            let isGram = false;
            
            // تحقق مما إذا كانت الوحدة الصغرى هي الجرام
            if (uuom && (uuom.toUpperCase().includes('GR') || uuom.toUpperCase().includes('GRAM') || uuom.includes('جرام'))) {
                isGram = true;
            }
            
            // البحث في أنماط الوحدات في جدول Excel
            const complexPatterns = [
                /\((\d+(\.\d+)?)\s*(KGS|KG|KILO|كجم|كيلو)/i,
                /\((\d+(\.\d+)?)\s*(G|GM|GRM|GRAM|جرام)/i,
                /\((\d+(\.\d+)?)\s*(LTR|L|LITRE|لتر)/i,
                /\((\d+(\.\d+)?)\s*(ML|مليلتر)/i,
                /\((\d+(\.\d+)?)\s*(PCS|PC|PIECES|قطعة|حبة)/i
            ];
            
            for (const pattern of complexPatterns) {
                const match = vendorUOM.match(pattern);
                if (match) {
                    const value = parseFloat(match[1]);
                    const unit = match[3].toUpperCase();
                    
                    if (unit.includes('KGS') || unit.includes('KG') || unit.includes('KILO') || unit.includes('كجم') || unit.includes('كيلو')) {
                        multiplier = value * 1000;
                        break;
                    } else if (unit.includes('G') || unit.includes('GM') || unit.includes('GRAM') || unit.includes('جرام')) {
                        multiplier = value;
                        break;
                    } else if (unit.includes('LTR') || unit.includes('L') || unit.includes('LITRE') || unit.includes('لتر')) {
                        multiplier = value * 1000;
                        break;
                    } else if (unit.includes('ML') || unit.includes('مليلتر')) {
                        multiplier = value;
                        break;
                    } else if (unit.includes('PCS') || unit.includes('PC') || unit.includes('PIECES') || unit.includes('قطعة') || unit.includes('حبة')) {
                        multiplier = value;
                        break;
                    }
                }
            }
            
            // إذا لم نجد نمطاً معقداً، ابحث في الوحدة مباشرة
            if (multiplier === 1) {
                // تحقق من أنماط الضرب
                if (vendorUOM.includes('×') || vendorUOM.includes('*')) {
                    const parts = vendorUOM.split(/[×*]/);
                    let totalMultiplier = 1;
                    
                    for (const part of parts) {
                        const numMatch = part.match(/(\d+(\.\d+)?)/);
                        if (numMatch) {
                            totalMultiplier *= parseFloat(numMatch[1]);
                        }
                    }
                    
                    multiplier = totalMultiplier;
                    
                    // إذا كانت تحتوي على KG أو كجم، حول إلى جرام
                    if (vendorUOMUpper.includes('KG') || vendorUOMUpper.includes('كجم')) {
                        multiplier *= 1000;
                    }
                    // إذا كانت تحتوي على LTR أو لتر، حول إلى مليلتر
                    else if (vendorUOMUpper.includes('LTR') || vendorUOMUpper.includes('لتر')) {
                        multiplier *= 1000;
                    }
                }
                // البحث عن وحدات بسيطة
                else {
                    for (const [unit, conv] of Object.entries(unitConversionMap)) {
                        if (vendorUOMUpper.includes(unit)) {
                            multiplier = conv;
                            
                            // إذا كانت الوحدة تحتوي على قيمة رقمية
                            const numMatch = vendorUOM.match(/(\d+(\.\d+)?)/);
                            if (numMatch) {
                                multiplier *= parseFloat(numMatch[1]);
                            }
                            break;
                        }
                    }
                }
            }
            
            // إذا كان المضاعف لا يزال 1، حاول استخراج أي رقم
            if (multiplier === 1) {
                const numMatch = vendorUOM.match(/(\d+(\.\d+)?)/);
                if (numMatch) {
                    multiplier = parseFloat(numMatch[1]);
                    
                    // إذا كانت تحتوي على كيلو أو كجم، حول إلى جرام
                    if (vendorUOMUpper.includes('KILO') || vendorUOMUpper.includes('KG') || vendorUOMUpper.includes('كجم') || vendorUOMUpper.includes('كيلo')) {
                        multiplier *= 1000;
                    }
                    // إذا كانت تحتوي على لتر، حول إلى مليلتر
                    else if (vendorUOMUpper.includes('LTR') || vendorUOMUpper.includes('لتر')) {
                        multiplier *= 1000;
                    }
                }
            }
            
            let result = quantity * multiplier;
            
            // تقريب النتيجة إلى أقرب رقم صحيح
            result = Math.round(result);
            
            return result;
        }

        // تحميل ملف Excel
        document.getElementById('excel-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // افتراض أن الاسم الأول هو الاسم الصحيح
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // تحويل إلى JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // معالجة البيانات
                inventoryData = jsonData.map(item => {
                    const stockQty = item.StockQty || 0;
                    const vendorUOM = item.VendorUOM || '';
                    const uuom = item.UUom || '';
                    
                    // حساب الكمية بالوحدة الصغرى باستخدام الدالة المحسنة
                    const smallestUnitQty = convertToSmallestUnit(stockQty, vendorUOM, uuom);
                    
                    // تحويل حركات الصنف إلى الوحدة الصغرى
                    const startQty = convertToSmallestUnit(item['Start Qty'] || 0, vendorUOM, uuom);
                    const receivedQty = convertToSmallestUnit(item['Received Qty'] || 0, vendorUOM, uuom);
                    const transferInQty = convertToSmallestUnit(item['Transfer In Qty'] || 0, vendorUOM, uuom);
                    const transferOutQty = convertToSmallestUnit(item['Transfer Out Qty'] || 0, vendorUOM, uuom);
                    const wastageQty = convertToSmallestUnit(item['Wastage Qty'] || 0, vendorUOM, uuom);
                    const usageQty = convertToSmallestUnit(item['Usage Qty'] || 0, vendorUOM, uuom);
                    const notConOrders = convertToSmallestUnit(item['Not Con. Orders'] || 0, vendorUOM, uuom);
                    
                    // تحديد المجموعة بناءً على Group واسم الصنف (محدث لفصل المقبلات)
                    const group = getItemGroup({
                        group: item.Group,
                        name: item.RMName
                    });
                    
                    return {
                        code: item['RM Code'] || '',
                        name: item.RMName || '',
                        vendorUOM: vendorUOM,
                        stockQty: stockQty,
                        uuom: uuom,
                        smallestUnitQty: smallestUnitQty,
                        startQty: startQty,
                        receivedQty: receivedQty,
                        transferInQty: transferInQty,
                        transferOutQty: transferOutQty,
                        wastageQty: wastageQty,
                        usageQty: usageQty,
                        notConOrders: notConOrders,
                        group: group,
                        selected: false,
                        actualCount: 0,
                        difference: 0
                    };
                });
                
                // تحديث الواجهة
                updateInventoryTable();
                updateStats();
                
                // إظهار إشعار
                showNotification('تم تحميل البيانات بنجاح!');
            };
            reader.readAsArrayBuffer(file);
        });

        // تحميل الأصناف الأساسية - الإصلاح
        document.getElementById('load-default-items').addEventListener('click', function() {
            // إضافة الأصناف الأساسية إلى inventoryData
            defaultItems.forEach(defaultItem => {
                // تجنب التكرار
                const existingItemIndex = inventoryData.findIndex(item => item.code === defaultItem.code);
                
                if (existingItemIndex === -1) {
                    // إضافة صنف جديد
                    inventoryData.push({
                        code: defaultItem.code,
                        name: defaultItem.name,
                        vendorUOM: defaultItem.vendorUOM,
                        stockQty: defaultItem.stockQty,
                        uuom: defaultItem.uuom,
                        smallestUnitQty: defaultItem.smallestUnitQty,
                        startQty: 0,
                        receivedQty: 0,
                        transferInQty: 0,
                        transferOutQty: 0,
                        wastageQty: 0,
                        usageQty: 0,
                        notConOrders: 0,
                        group: defaultItem.group,
                        selected: true,
                        actualCount: 0,
                        difference: 0
                    });
                } else {
                    // تحديث الصنف الموجود واختياره للجرد
                    inventoryData[existingItemIndex].selected = true;
                    inventoryData[existingItemIndex].group = defaultItem.group;
                }
            });
            
            // تحديث الأصناف المختارة
            selectedItems = inventoryData.filter(item => item.selected);
            
            // تحديث الواجهة
            updateInventoryTable();
            updateStats();
            
            // تحديث صفحات الجرد إذا كانت مفتوحة
            if (document.getElementById('meat-section').classList.contains('active')) {
                updateMeatInventory();
            } else if (document.getElementById('veg-section').classList.contains('active')) {
                updateVegInventory();
            } else if (document.getElementById('appetizers-section').classList.contains('active')) {
                updateAppetizersInventory();
            }
            
            // إظهار إشعار
            showNotification('تم تحميل الأصناف الأساسية بنجاح! تم اختيار ' + defaultItems.length + ' صنف للجرد.');
        });

        // تحديث جدول الأصناف
        function updateInventoryTable() {
            const tableBody = document.getElementById('items-table-body');
            tableBody.innerHTML = '';
            
            const searchTerm = document.getElementById('search-items').value.toLowerCase();
            
            let filteredData = inventoryData;
            if (searchTerm) {
                filteredData = inventoryData.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) || 
                    (item.code && item.code.toLowerCase().includes(searchTerm))
                );
            }
            
            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.code || ''}</td>
                    <td>${item.name || ''}</td>
                    <td>${item.vendorUOM || ''}</td>
                    <td>${item.stockQty || 0}</td>
                    <td>${item.uuom || ''}</td>
                    <td>${item.smallestUnitQty || 0}</td>
                    <td>
                        <input type="checkbox" class="item-select" data-code="${item.code}" ${item.selected ? 'checked' : ''}>
                    </td>
                    <td>
                        <button class="btn btn-small btn-secondary show-movement" data-code="${item.code}">
                            عرض الحركة
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // إضافة مستمعات الأحداث لخانات الاختيار
            document.querySelectorAll('.item-select').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const code = this.getAttribute('data-code');
                    const item = inventoryData.find(i => i.code === code);
                    if (item) {
                        item.selected = this.checked;
                        
                        if (this.checked && !selectedItems.find(i => i.code === code)) {
                            selectedItems.push(item);
                        } else if (!this.checked) {
                            selectedItems = selectedItems.filter(i => i.code !== code);
                        }
                        
                        updateStats();
                        
                        // تحديث صفحات الجرد إذا كانت مفتوحة
                        if (document.getElementById('meat-section').classList.contains('active')) {
                            updateMeatInventory();
                        } else if (document.getElementById('veg-section').classList.contains('active')) {
                            updateVegInventory();
                        } else if (document.getElementById('appetizers-section').classList.contains('active')) {
                            updateAppetizersInventory();
                        }
                    }
                });
            });
            
            // إضافة مستمعات الأحداث لأزرار عرض الحركة
            document.querySelectorAll('.show-movement').forEach(button => {
                button.addEventListener('click', function() {
                    const code = this.getAttribute('data-code');
                    showMovementModal(code);
                });
            });
        }

        // عرض نافذة الحركة
        function showMovementModal(code) {
            const item = inventoryData.find(i => i.code === code);
            if (!item) return;
            
            const modal = document.getElementById('movement-modal');
            const title = document.getElementById('movement-modal-title');
            const content = document.getElementById('movement-modal-content');
            
            title.textContent = `حركة الصنف: ${item.name}`;
            
            // حساب الرصيد الحالي من الحركات
            const currentStock = item.startQty + item.receivedQty + item.transferInQty - 
                               item.transferOutQty - item.wastageQty - item.usageQty - item.notConOrders;
            
            content.innerHTML = `
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>البداية</th>
                            <th>المستلم</th>
                            <th>التحويل الداخل</th>
                            <th>التحويل الخارج</th>
                            <th>الهالك</th>
                            <th>الاستخدام</th>
                            <th>الطلبات غير المكتملة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${item.startQty}</td>
                            <td>${item.receivedQty}</td>
                            <td>${item.transferInQty}</td>
                            <td>${item.transferOutQty}</td>
                            <td>${item.wastageQty}</td>
                            <td>${item.usageQty}</td>
                            <td>${item.notConOrders}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="current-stock">
                    الرصيد الحالي: ${currentStock} ${item.uuom}
                </div>
                <p style="margin-top: 10px; text-align: center; font-size: 12px;">جميع الأرقام بالوحدة الصغرى: ${item.uuom}</p>
            `;
            
            modal.style.display = 'flex';
        }

        // تحديث الإحصائيات
        function updateStats() {
            document.getElementById('total-items').textContent = inventoryData.length;
            
            const lowStockItems = inventoryData.filter(item => item.stockQty < 5).length;
            document.getElementById('low-stock-items').textContent = lowStockItems;
            
            document.getElementById('selected-items').textContent = selectedItems.length;
        }

        // البحث في الأصناف
        document.getElementById('search-items').addEventListener('input', updateInventoryTable);

        // وظيفة البحث الديناميكي للمطاعم
        function setupRestaurantAutocomplete(inputId, suggestionsId, managerIds) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                suggestions.innerHTML = '';
                
                if (query.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                const filteredRestaurants = restaurants.filter(restaurant => 
                    restaurant.name.includes(query)
                );
                
                if (filteredRestaurants.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                filteredRestaurants.forEach(restaurant => {
                    const div = document.createElement('div');
                    div.className = 'restaurant-suggestion';
                    div.textContent = restaurant.name;
                    
                    div.addEventListener('click', function() {
                        input.value = restaurant.name;
                        document.getElementById(managerIds.restaurantName).value = restaurant.name;
                        
                        // تحديث معلومات المديرين
                        if (managerIds.areaManager) {
                            document.getElementById(managerIds.areaManager).textContent = restaurant.areaManager;
                        }
                        if (managerIds.operationsManager) {
                            document.getElementById(managerIds.operationsManager).textContent = restaurant.operationsManager;
                        }
                        
                        suggestions.style.display = 'none';
                    });
                    
                    suggestions.appendChild(div);
                });
                
                suggestions.style.display = 'block';
            });
            
            // إخفاء القائمة عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        // التنقل بين الأقسام
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // إزالة النشاط من جميع الأقسام
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                // إضافة النشاط للقسم المحدد
                this.classList.add('active');
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
                
                // إذا كان القسم هو جرد اللحوم أو الخضروات أو المقبلات، قم بتحديث العرض
                if (targetId === 'meat-section') {
                    updateMeatInventory();
                } else if (targetId === 'veg-section') {
                    updateVegInventory();
                } else if (targetId === 'appetizers-section') {
                    updateAppetizersInventory();
                } else if (targetId === 'settings-section') {
                    updateRestaurantsTable();
                }
            });
        });

        // تحديد الأصناف المتشابهة في اللحوم مع تحسين الترتيب
        function findSimilarItems(items) {
            const similarGroups = {};
            
            items.forEach(item => {
                let baseName = item.name;
                
                // إزالة الكلمات الشائعة للعثور على الأصناف المتشابهة
                baseName = baseName.replace(/\(.*?\)/g, '').trim(); // إزالة ما بين الأقواس
                
                // تحسين التعرف على الأصناف المتشابهة
                if (baseName.includes("Chicken Big Fillet")) {
                    baseName = "Chicken Big Fillet";
                } else if (baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Grilled")) {
                    baseName = "Chicken Fillet";
                } else if (baseName.includes("Chicken Finger Fillet") || baseName.includes("Ch.Finger Fillet")) {
                    baseName = "Chicken Finger Fillet";
                } else if (baseName.includes("Chicken Tikka")) {
                    baseName = "Chicken Tikka";
                } else if (baseName.includes("Chicken Fried")) {
                    baseName = "Chicken Fried";
                } else if (baseName.includes("Chicken Small Wings")) {
                    baseName = "Chicken Small Wings";
                } else if (baseName.includes("Chicken Wings")) {
                    baseName = "Chicken Wings";
                } else if (baseName.includes("Drumstick whole Fried")) {
                    baseName = "Drumstick whole Fried";
                } else if (baseName.includes("وصلة دجاج")) {
                    baseName = "وصلة دجاج";
                } else if (baseName.includes("Chicken Burger") && !baseName.includes("Fresh")) {
                    baseName = "Chicken Burger";
                } else if (baseName.includes("Beef Burger Big")) {
                    baseName = "Beef Burger Big";
                } else if (baseName.includes("Beef Burger Small")) {
                    baseName = "Beef Burger Small";
                } else if (baseName.includes("Fresh Burger Chickens")) {
                    baseName = "Fresh Burger Chickens";
                }
                
                // تجميع فروج نايف مع بنت الديك
                if (baseName.includes("Rooster Junior") || baseName.includes("Bint Al-Deek") || 
                    item.name.includes("فروج نايف") || item.name.includes("بنت الديك")) {
                    baseName = "فروج/بنت الديك";
                }
                
                // تجميع الفيليه المشوي مع الفيليه العادي والفيليه فلفل
                if (baseName.includes("Grilled Chicken Fillet") || 
                    baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Big") ||
                    item.name.includes("فيليه مشوي") || item.name.includes("فيليه عادي") || item.name.includes("فيليه فلفل")) {
                    if (!baseName.includes("Finger") && !baseName.includes("Big")) {
                        baseName = "فيليه دجاج";
                    }
                }
                
                if (!similarGroups[baseName]) {
                    similarGroups[baseName] = [];
                }
                
                similarGroups[baseName].push(item);
            });
            
            // ترشيح المجموعات التي تحتوي على أكثر من صنف واحد
            const filteredGroups = {};
            for (const group in similarGroups) {
                if (similarGroups[group].length > 1) {
                    filteredGroups[group] = similarGroups[group];
                }
            }
            
            return filteredGroups;
        }

        // تحديث عرض جرد اللحوم مع إضافة كلمة عجز/زيادة والعمود الجديد
        function updateMeatInventory() {
            const container = document.getElementById('meat-inventory-container');
            container.innerHTML = '';
            
            // تصفية الأصناف المختارة التي تنتمي لللحوم
            let meatItems = selectedItems.filter(item => 
                item.group === 'meat'
            );
            
            if (meatItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--primary); font-weight: bold;">لم يتم اختيار أي أصناف لحوم للجرد</p>';
                return;
            }
            
            // البحث عن الأصناف المتشابهة
            const similarGroups = findSimilarItems(meatItems);
            
            // ترتيب الأصناف بشكل يدوي لتجميع الأصناف المتشابهة
            meatItems.sort((a, b) => {
                // ترتيب خاص لتجميع الأصناف المتشابهة
                const groupsOrder = {
                    "Chicken Big Fillet": 1,
                    "فيليه دجاج": 2,
                    "Chicken Finger Fillet": 3,
                    "Chicken Tikka": 4,
                    "Chicken Fried": 5,
                    "Chicken Small Wings": 6,
                    "Chicken Wings": 7,
                    "Drumstick whole Fried": 8,
                    "وصلة دجاج": 9,
                    "Chicken Burger": 10,
                    "Beef Burger Big": 11,
                    "Beef Burger Small": 12,
                    "Fresh Burger Chickens": 13,
                    "فروج/بنت الديك": 14
                };
                
                let groupA = "";
                let groupB = "";
                
                for (const group in groupsOrder) {
                    if (a.name.includes(group) || group === "فيليه دجاج" && 
                        (a.name.includes("Grilled Chicken Fillet") || 
                         (a.name.includes("Chicken Fillet") && !a.name.includes("Finger") && !a.name.includes("Big")))) {
                        groupA = group;
                        break;
                    }
                }
                
                for (const group in groupsOrder) {
                    if (b.name.includes(group) || group === "فيليه دجاج" && 
                        (b.name.includes("Grilled Chicken Fillet") || 
                         (b.name.includes("Chicken Fillet") && !b.name.includes("Finger") && !b.name.includes("Big")))) {
                        groupB = group;
                        break;
                    }
                }
                
                if (groupA && groupB) {
                    return groupsOrder[groupA] - groupsOrder[groupB];
                } else if (groupA) {
                    return -1;
                } else if (groupB) {
                    return 1;
                }
                
                return a.name.localeCompare(b.name);
            });
            
            // تجميع الأصناف حسب المجموعات الفرعية
            const groupedItems = {};
            meatItems.forEach(item => {
                // تحديد المجموعة الفرعية بناءً على اسم الصنف
                let subGroup = 'أخرى';
                
                if (item.name.includes('Big Fillet')) {
                    subGroup = 'بيج فيليه';
                } else if (item.name.includes('Finger Fillet')) {
                    subGroup = 'أصابع فيليه';
                } else if (item.name.includes('Grilled Chicken Fillet') || 
                          (item.name.includes('Chicken Fillet') && !item.name.includes('Finger') && !item.name.includes('Big'))) {
                    subGroup = 'فيليه دجاج';
                } else if (item.name.includes('Tikka')) {
                    subGroup = 'تيكا';
                } else if (item.name.includes('Fried')) {
                    subGroup = 'فرايد';
                } else if (item.name.includes('Burger') && !item.name.includes('Fresh')) {
                    subGroup = 'برجر';
                } else if (item.name.includes('Fresh Burger Chickens')) {
                    subGroup = 'برجر طازج';
                } else if (item.name.includes('Wings')) {
                    subGroup = 'جناح';
                } else if (item.name.includes('Drumstick') || item.name.includes('وصلة دجاج')) {
                    subGroup = 'درام ستيك/وصلة';
                } else if (item.name.includes('Quils') || item.name.includes('فري')) {
                    subGroup = 'فري';
                } else if (item.name.includes('Rooster') || item.name.includes('فروج') || 
                          item.name.includes('Bint Al-Deek') || item.name.includes('بنت الديك')) {
                    subGroup = 'فروج/بنت الديك';
                } else if (item.name.includes('Royal')) {
                    subGroup = 'ملكي';
                }
                
                if (!groupedItems[subGroup]) {
                    groupedItems[subGroup] = [];
                }
                
                groupedItems[subGroup].push(item);
            });
            
            // عرض الأصناف المجمعة في جدول
            for (const group in groupedItems) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'inventory-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'category-title';
                titleDiv.textContent = group;
                categoryDiv.appendChild(titleDiv);
                
                const table = document.createElement('table');
                table.className = 'inventory-table';
                
                // رأس الجدول مع العمود الجديد
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>م</th>
                        <th>اسم الصنف</th>
                        <th>الشد</th>
                        <th>الجرد من البرنامج</th>
                        <th class="count-cell">الجرد بالوحدة الصغرى</th>
                        <th>الجرد الفعلي</th>
                        <th class="difference-cell">العجز/الزيادة</th>
                        <th>الفروقات المجمعة</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                let rowIndex = 0;
                let processedItems = new Set();
                
                groupedItems[group].forEach((item, index) => {
                    // تخطي العناصر التي تمت معالجتها بالفعل في مجموعة متشابهة
                    if (processedItems.has(item.code)) {
                        return;
                    }
                    
                    // البحث عما إذا كان هذا العنصر جزءًا من مجموعة متشابهة
                    let similarItems = [];
                    let isPartOfSimilarGroup = false;
                    
                    for (const baseName in similarGroups) {
                        const groupItems = similarGroups[baseName];
                        const similarItem = groupItems.find(i => i.code === item.code);
                        if (similarItem && groupItems.length > 1) {
                            similarItems = groupItems;
                            isPartOfSimilarGroup = true;
                            break;
                        }
                    }
                    
                    if (isPartOfSimilarGroup && similarItems.length > 0) {
                        // عرض جميع العناصر المتشابهة معًا
                        similarItems.forEach((similarItem, similarIndex) => {
                            const row = document.createElement('tr');
                            
                            // تحديد لون الفرق وإضافة كلمة عجز/زيادة
                            const difference = similarItem.difference || 0;
                            const differenceClass = difference < 0 ? 'difference-negative' : 
                                                   difference > 0 ? 'difference-positive' : '';
                            const differenceText = difference < 0 ? 'عجز' : 
                                                  difference > 0 ? 'زيادة' : '';
                            
                            row.innerHTML = `
                                <td>${rowIndex + 1}</td>
                                <td>${similarItem.name}</td>
                                <td>${similarItem.vendorUOM}</td>
                                <td>${similarItem.stockQty}</td>
                                <td class="count-cell">${similarItem.smallestUnitQty}</td>
                                <td>
                                    <input type="number" class="actual-count-input" data-code="${similarItem.code}" 
                                           value="${similarItem.actualCount || ''}" placeholder="0">
                                </td>
                                <td class="difference-cell ${differenceClass}" data-code="${similarItem.code}" style="font-size: 18px; font-weight: bold;">
                                    ${difference} ${differenceText ? `<span class="difference-text" style="color: ${differenceClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${differenceText})</span>` : ''}
                                </td>
                            `;
                            
                            // إذا كان هذا هو الصف الأول في المجموعة المتشابهة، أضف الخلية المجمعة
                            if (similarIndex === 0) {
                                const combinedDifference = similarItems.reduce((sum, i) => sum + (i.difference || 0), 0);
                                const combinedClass = combinedDifference < 0 ? 'combined-difference-negative' : 
                                                     combinedDifference > 0 ? 'combined-difference-positive' : 'combined-difference-zero';
                                const combinedText = combinedDifference < 0 ? 'عجز' : 
                                                    combinedDifference > 0 ? 'زيادة' : 'متساوي';
                                
                                const combinedCell = document.createElement('td');
                                combinedCell.className = `combined-difference-cell ${combinedClass}`;
                                combinedCell.rowSpan = similarItems.length;
                                combinedCell.innerHTML = `${combinedDifference}<br><span style="font-size: 14px;">(${combinedText})</span>`;
                                combinedCell.setAttribute('data-similar-group', similarItems.map(i => i.code).join(','));
                                row.appendChild(combinedCell);
                            }
                            
                            tbody.appendChild(row);
                            processedItems.add(similarItem.code);
                            rowIndex++;
                            
                            // إضافة مستمع حدث لحساب الفرق وتحديث الخلية المجمعة
                            const input = row.querySelector('.actual-count-input');
                            input.addEventListener('input', function() {
                                const actualCount = parseFloat(this.value) || 0;
                                const difference = actualCount - similarItem.smallestUnitQty;
                                const differenceText = difference < 0 ? 'عجز' : 
                                                      difference > 0 ? 'زيادة' : '';
                                
                                // تحديث الفرق في الخلية مع التلوين والنص
                                const differenceCell = document.querySelector(`.difference-cell[data-code="${similarItem.code}"]`);
                                differenceCell.innerHTML = `${Math.round(difference)} ${differenceText ? `<span class="difference-text" style="color: ${difference < 0 ? 'var(--accent-red)' : difference > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${differenceText})</span>` : ''}`;
                                
                                // تحديث اللون بناءً على القيمة
                                differenceCell.classList.remove('difference-negative', 'difference-positive');
                                if (difference < 0) {
                                    differenceCell.classList.add('difference-negative');
                                } else if (difference > 0) {
                                    differenceCell.classList.add('difference-positive');
                                }
                                
                                // تحديث بيانات العنصر
                                similarItem.actualCount = actualCount;
                                similarItem.difference = Math.round(difference);
                                
                                // تحديث الخلية المجمعة
                                updateCombinedDifferenceCell(similarItems);
                                
                                // إعادة حساب المجموع
                                updateGroupTotal(group, groupedItems[group]);
                            });
                        });
                    } else {
                        // عرض العنصر العادي
                        const row = document.createElement('tr');
                        
                        // تحديد لون الفرق وإضافة كلمة عجز/زيادة
                        const difference = item.difference || 0;
                        const differenceClass = difference < 0 ? 'difference-negative' : 
                                               difference > 0 ? 'difference-positive' : '';
                        const differenceText = difference < 0 ? 'عجز' : 
                                              difference > 0 ? 'زيادة' : '';
                        
                        row.innerHTML = `
                            <td>${rowIndex + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.vendorUOM}</td>
                            <td>${item.stockQty}</td>
                            <td class="count-cell">${item.smallestUnitQty}</td>
                            <td>
                                <input type="number" class="actual-count-input" data-code="${item.code}" 
                                       value="${item.actualCount || ''}" placeholder="0">
                            </td>
                            <td class="difference-cell ${differenceClass}" data-code="${item.code}" style="font-size: 18px; font-weight: bold;">
                                ${difference} ${differenceText ? `<span class="difference-text" style="color: ${differenceClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${differenceText})</span>` : ''}
                            </td>
                            <td class="combined-difference-cell combined-difference-zero" data-code="${item.code}">
                                ${difference}<br><span style="font-size: 14px;">(${differenceText || 'متساوي'})</span>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                        processedItems.add(item.code);
                        rowIndex++;
                        
                        // إضافة مستمع حدث لحساب الفرق
                        const input = row.querySelector('.actual-count-input');
                        input.addEventListener('input', function() {
                            const actualCount = parseFloat(this.value) || 0;
                            const difference = actualCount - item.smallestUnitQty;
                            const differenceText = difference < 0 ? 'عجز' : 
                                                  difference > 0 ? 'زيادة' : '';
                            
                            // تحديث الفرق في الخلية مع التلوين والنص
                            const differenceCell = document.querySelector(`.difference-cell[data-code="${item.code}"]`);
                            differenceCell.innerHTML = `${Math.round(difference)} ${differenceText ? `<span class="difference-text" style="color: ${difference < 0 ? 'var(--accent-red)' : difference > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${differenceText})</span>` : ''}`;
                            
                            // تحديث اللون بناءً على القيمة
                            differenceCell.classList.remove('difference-negative', 'difference-positive');
                            if (difference < 0) {
                                differenceCell.classList.add('difference-negative');
                            } else if (difference > 0) {
                                differenceCell.classList.add('difference-positive');
                            }
                            
                            // تحديث الخلية المجمعة
                            const combinedCell = row.querySelector('.combined-difference-cell');
                            const combinedClass = difference < 0 ? 'combined-difference-negative' : 
                                                 difference > 0 ? 'combined-difference-positive' : 'combined-difference-zero';
                            combinedCell.className = `combined-difference-cell ${combinedClass}`;
                            combinedCell.innerHTML = `${Math.round(difference)}<br><span style="font-size: 14px;">(${differenceText || 'متساوي'})</span>`;
                            
                            // تحديث بيانات العنصر
                            item.actualCount = actualCount;
                            item.difference = Math.round(difference);
                            
                            // إعادة حساب المجموع
                            updateGroupTotal(group, groupedItems[group]);
                        });
                    }
                });
                
                table.appendChild(tbody);
                
                // صف المجموع
                const totalRow = document.createElement('tr');
                totalRow.className = 'group-total';
                const groupTotalValue = groupedItems[group].reduce((sum, item) => sum + (item.difference || 0), 0);
                const groupTotalClass = groupTotalValue < 0 ? 'difference-negative' : 
                                       groupTotalValue > 0 ? 'difference-positive' : '';
                const groupTotalText = groupTotalValue < 0 ? 'عجز' : 
                                      groupTotalValue > 0 ? 'زيادة' : '';
                totalRow.innerHTML = `
                    <td colspan="7">إجمالي ${group}</td>
                    <td class="group-total-cell ${groupTotalClass}" data-group="${group}" style="font-size: 18px; font-weight: bold;">
                        ${groupTotalValue} ${groupTotalText ? `<span class="difference-text" style="color: ${groupTotalClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${groupTotalText})</span>` : ''}
                    </td>
                `;
                table.appendChild(totalRow);
                
                categoryDiv.appendChild(table);
                container.appendChild(categoryDiv);
            }
        }

        // تحديث الخلية المجمعة للأصناف المتشابهة
        function updateCombinedDifferenceCell(similarItems) {
            const combinedDifference = similarItems.reduce((sum, item) => sum + (item.difference || 0), 0);
            const combinedClass = combinedDifference < 0 ? 'combined-difference-negative' : 
                                 combinedDifference > 0 ? 'combined-difference-positive' : 'combined-difference-zero';
            const combinedText = combinedDifference < 0 ? 'عجز' : 
                                combinedDifference > 0 ? 'زيادة' : 'متساوي';
            
            // العثور على الخلية المجمعة وتحديثها
            const combinedCell = document.querySelector(`.combined-difference-cell[data-similar-group="${similarItems.map(i => i.code).join(',')}"]`);
            if (combinedCell) {
                combinedCell.className = `combined-difference-cell ${combinedClass}`;
                combinedCell.innerHTML = `${combinedDifference}<br><span style="font-size: 14px;">(${combinedText})</span>`;
            }
        }

        // تحديث عرض جرد الخضروات مع إضافة كلمة عجز/زيادة
        function updateVegInventory() {
            const container = document.getElementById('veg-inventory-container');
            container.innerHTML = '';
            
            // تصفية الأصناف المختارة التي تنتمي للخضروات
            const vegItems = selectedItems.filter(item => 
                item.group === 'vegetables'
            );
            
            if (vegItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--accent-green); font-weight: bold;">لم يتم اختيار أي أصناف خضروات للجرد</p>';
                return;
            }
            
            // تجميع الأصناف حسب المجموعات الفرعية
            const groupedItems = {};
            vegItems.forEach(item => {
                // تحديد المجموعة الفرعية بناءً على اسم الصنف
                let subGroup = 'أخرى';
                if (item.name && (item.name.includes('خيار') || item.name.includes('طماطم') || item.name.includes('بصل'))) {
                    subGroup = 'خضروات أساسية';
                } else if (item.name && (item.name.includes('فلفل') || item.name.includes('جزر') || item.name.includes('بقدونس'))) {
                    subGroup = 'خضروات متنوعة';
                } else if (item.name && (item.name.includes('ليمون') || item.name.includes('برتقال'))) {
                    subGroup = 'حمضيات';
                } else if (item.name && item.name.includes('خس')) {
                    subGroup = 'أوراق خضراء';
                }
                
                if (!groupedItems[subGroup]) {
                    groupedItems[subGroup] = [];
                }
                
                groupedItems[subGroup].push(item);
            });
            
            // عرض الأصناف المجمعة في جدول
            for (const group in groupedItems) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'inventory-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'category-title-green';
                titleDiv.textContent = group;
                categoryDiv.appendChild(titleDiv);
                
                const table = document.createElement('table');
                table.className = 'inventory-table';
                
                // رأس الجدول
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>م</th>
                        <th>اسم الصنف</th>
                        <th>الشد</th>
                        <th>الجرد من البرنامج</th>
                        <th class="count-cell">الجرد بالوحدة الصغرى</th>
                        <th>الجرد الفعلي</th>
                        <th class="difference-cell">العجز/الزيادة</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                groupedItems[group].forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    // تحديد لون الفرق وإضافة كلمة عجز/زيادة
                    const difference = item.difference || 0;
                    const differenceClass = difference < 0 ? 'difference-negative' : 
                                           difference > 0 ? 'difference-positive' : '';
                    const differenceText = difference < 0 ? 'عجز' : 
                                          difference > 0 ? 'زيادة' : '';
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.vendorUOM}</td>
                        <td>${item.stockQty}</td>
                        <td class="count-cell">${item.smallestUnitQty}</td>
                        <td>
                            <input type="number" class="actual-count-input" data-code="${item.code}" 
                                   value="${item.actualCount || ''}" placeholder="0">
                        </td>
                        <td class="difference-cell ${differenceClass}" data-code="${item.code}" style="font-size: 18px; font-weight: bold;">
                            ${difference} ${differenceText ? `<span class="difference-text" style="color: ${differenceClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${differenceText})</span>` : ''}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    
                    // إضافة مستمع حدث لحساب الفرق
                    const input = row.querySelector('.actual-count-input');
                    input.addEventListener('input', function() {
                        const actualCount = parseFloat(this.value) || 0;
                        const difference = actualCount - item.smallestUnitQty;
                        const differenceText = difference < 0 ? 'عجز' : 
                                              difference > 0 ? 'زيادة' : '';
                        
                        // تحديث الفرق في الخلية مع التلوين والنص
                        const differenceCell = document.querySelector(`.difference-cell[data-code="${item.code}"]`);
                        differenceCell.innerHTML = `${Math.round(difference)} ${differenceText ? `<span class="difference-text" style="color: ${difference < 0 ? 'var(--accent-red)' : difference > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${differenceText})</span>` : ''}`;
                        
                        // تحديث اللون بناءً على القيمة
                        differenceCell.classList.remove('difference-negative', 'difference-positive');
                        if (difference < 0) {
                            differenceCell.classList.add('difference-negative');
                        } else if (difference > 0) {
                            differenceCell.classList.add('difference-positive');
                        }
                        
                        // تحديث بيانات العنصر
                        item.actualCount = actualCount;
                        item.difference = Math.round(difference);
                        
                        // إعادة حساب المجموع
                        updateGroupTotal(group, groupedItems[group]);
                    });
                });
                
                table.appendChild(tbody);
                
                // صف المجموع
                const totalRow = document.createElement('tr');
                totalRow.className = 'group-total';
                const groupTotalValue = groupedItems[group].reduce((sum, item) => sum + (item.difference || 0), 0);
                const groupTotalClass = groupTotalValue < 0 ? 'difference-negative' : 
                                       groupTotalValue > 0 ? 'difference-positive' : '';
                const groupTotalText = groupTotalValue < 0 ? 'عجز' : 
                                      groupTotalValue > 0 ? 'زيادة' : '';
                totalRow.innerHTML = `
                    <td colspan="6">إجمالي ${group}</td>
                    <td class="group-total-cell ${groupTotalClass}" data-group="${group}" style="font-size: 18px; font-weight: bold;">
                        ${groupTotalValue} ${groupTotalText ? `<span class="difference-text" style="color: ${groupTotalClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${groupTotalText})</span>` : ''}
                    </td>
                `;
                table.appendChild(totalRow);
                
                categoryDiv.appendChild(table);
                container.appendChild(categoryDiv);
            }
        }

        // تحديد السلطات في المقبلات
        function isSaladItem(item) {
            return item.name && (
                item.name.includes('سلطة') || 
                item.name.includes('فتوش') || 
                item.name.includes('تبولة') || 
                item.name.includes('كول سلو') ||
                item.name.includes('جرجير')
            );
        }

        // تحديث عرض جرد المقبلات مع إضافة كلمة عجز/زيادة
        function updateAppetizersInventory() {
            const container = document.getElementById('appetizers-inventory-container');
            container.innerHTML = '';
            
            // تصفية الأصناف المختارة التي تنتمي للمقبلات
            const appetizersItems = selectedItems.filter(item => 
                item.group === 'appetizers'
            );
            
            if (appetizersItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--accent-orange); font-weight: bold;">لم يتم اختيار أي أصناف مقبلات للجرد</p>';
                return;
            }
            
            // فصل السلطات عن باقي الأصناف
            const saladItems = [];
            const otherItems = [];
            
            appetizersItems.forEach(item => {
                if (isSaladItem(item)) {
                    saladItems.push(item);
                } else {
                    otherItems.push(item);
                }
            });
            
            // عرض السلطات أولاً مع مجموعة واحدة
            if (saladItems.length > 0) {
                const saladsCategoryDiv = document.createElement('div');
                saladsCategoryDiv.className = 'inventory-category';
                
                const saladsTitleDiv = document.createElement('div');
                saladsTitleDiv.className = 'category-title-orange';
                saladsTitleDiv.textContent = 'السلطات';
                saladsCategoryDiv.appendChild(saladsTitleDiv);
                
                const saladsTable = document.createElement('table');
                saladsTable.className = 'inventory-table';
                
                // رأس الجدول
                const saladsThead = document.createElement('thead');
                saladsThead.innerHTML = `
                    <tr>
                        <th>م</th>
                        <th>اسم الصنف</th>
                        <th>الشد</th>
                        <th>الجرد من البرنامج</th>
                        <th class="count-cell">الجرد بالوحدة الصغرى</th>
                        <th>الجرد الفعلي</th>
                        <th class="difference-cell">العجز/الزيادة</th>
                        <th>الفروقات المجمعة</th>
                    </tr>
                `;
                saladsTable.appendChild(saladsThead);
                
                const saladsTbody = document.createElement('tbody');
                let saladRowIndex = 0;
                
                // عرض كل السلطات معًا في مجموعة واحدة
                saladItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    // تحديد لون الفرق وإضافة كلمة عجز/زيادة
                    const difference = item.difference || 0;
                    const differenceClass = difference < 0 ? 'difference-negative' : 
                                           difference > 0 ? 'difference-positive' : '';
                    const differenceText = difference < 0 ? 'عجز' : 
                                          difference > 0 ? 'زيادة' : '';
                    
                    row.innerHTML = `
                        <td>${saladRowIndex + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.vendorUOM}</td>
                        <td>${item.stockQty}</td>
                        <td class="count-cell">${item.smallestUnitQty}</td>
                        <td>
                            <input type="number" class="actual-count-input" data-code="${item.code}" 
                                   value="${item.actualCount || ''}" placeholder="0">
                        </td>
                        <td class="difference-cell ${differenceClass}" data-code="${item.code}" style="font-size: 18px; font-weight: bold;">
                            ${difference} ${differenceText ? `<span class="difference-text" style="color: ${differenceClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${differenceText})</span>` : ''}
                        </td>
                    `;
                    
                    // إذا كان هذا هو الصف الأول، أضف الخلية المجمعة
                    if (index === 0) {
                        const saladsTotalDifference = saladItems.reduce((sum, i) => sum + (i.difference || 0), 0);
                        const saladsTotalClass = saladsTotalDifference < 0 ? 'combined-difference-negative' : 
                                               saladsTotalDifference > 0 ? 'combined-difference-positive' : 'combined-difference-zero';
                        const saladsTotalText = saladsTotalDifference < 0 ? 'عجز' : 
                                              saladsTotalDifference > 0 ? 'زيادة' : 'متساوي';
                        
                        const combinedCell = document.createElement('td');
                        combinedCell.className = `combined-difference-cell ${saladsTotalClass}`;
                        combinedCell.rowSpan = saladItems.length;
                        combinedCell.innerHTML = `${saladsTotalDifference}<br><span style="font-size: 14px;">(${saladsTotalText})</span>`;
                        combinedCell.setAttribute('data-similar-group', 'salads-group');
                        row.appendChild(combinedCell);
                    }
                    
                    saladsTbody.appendChild(row);
                    saladRowIndex++;
                    
                    // إضافة مستمع حدث لحساب الفرق وتحديث الخلية المجمعة
                    const input = row.querySelector('.actual-count-input');
                    input.addEventListener('input', function() {
                        const actualCount = parseFloat(this.value) || 0;
                        const difference = actualCount - item.smallestUnitQty;
                        const differenceText = difference < 0 ? 'عجز' : 
                                              difference > 0 ? 'زيادة' : '';
                        
                        // تحديث الفرق في الخلية مع التلوين والنص
                        const differenceCell = document.querySelector(`.difference-cell[data-code="${item.code}"]`);
                        differenceCell.innerHTML = `${Math.round(difference)} ${differenceText ? `<span class="difference-text" style="color: ${difference < 0 ? 'var(--accent-red)' : difference > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${differenceText})</span>` : ''}`;
                        
                        // تحديث اللون بناءً على القيمة
                        differenceCell.classList.remove('difference-negative', 'difference-positive');
                        if (difference < 0) {
                            differenceCell.classList.add('difference-negative');
                        } else if (difference > 0) {
                            differenceCell.classList.add('difference-positive');
                        }
                        
                        // تحديث بيانات العنصر
                        item.actualCount = actualCount;
                        item.difference = Math.round(difference);
                        
                        // تحديث الخلية المجمعة للسلطات
                        const saladsTotalDifference = saladItems.reduce((sum, i) => sum + (i.difference || 0), 0);
                        const saladsTotalClass = saladsTotalDifference < 0 ? 'combined-difference-negative' : 
                                               saladsTotalDifference > 0 ? 'combined-difference-positive' : 'combined-difference-zero';
                        const saladsTotalText = saladsTotalDifference < 0 ? 'عجز' : 
                                              saladsTotalDifference > 0 ? 'زيادة' : 'متساوي';
                        
                        const combinedCell = document.querySelector('.combined-difference-cell[data-similar-group="salads-group"]');
                        if (combinedCell) {
                            combinedCell.className = `combined-difference-cell ${saladsTotalClass}`;
                            combinedCell.innerHTML = `${saladsTotalDifference}<br><span style="font-size: 14px;">(${saladsTotalText})</span>`;
                        }
                    });
                });
                
                saladsTable.appendChild(saladsTbody);
                
                // صف المجموع للسلطات
                const saladsTotalRow = document.createElement('tr');
                saladsTotalRow.className = 'group-total';
                const saladsTotalValue = saladItems.reduce((sum, item) => sum + (item.difference || 0), 0);
                const saladsTotalClass = saladsTotalValue < 0 ? 'difference-negative' : 
                                       saladsTotalValue > 0 ? 'difference-positive' : '';
                const saladsTotalText = saladsTotalValue < 0 ? 'عجز' : 
                                      saladsTotalValue > 0 ? 'زيادة' : '';
                saladsTotalRow.innerHTML = `
                    <td colspan="7">إجمالي السلطات</td>
                    <td class="group-total-cell ${saladsTotalClass}" data-group="السلطات" style="font-size: 18px; font-weight: bold;">
                        ${saladsTotalValue} ${saladsTotalText ? `<span class="difference-text" style="color: ${saladsTotalClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${saladsTotalText})</span>` : ''}
                    </td>
                `;
                saladsTable.appendChild(saladsTotalRow);
                
                saladsCategoryDiv.appendChild(saladsTable);
                container.appendChild(saladsCategoryDiv);
            }
            
            // عرض باقي الأصناف
            if (otherItems.length > 0) {
                // تجميع الأصناف حسب المجموعات الفرعية
                const groupedItems = {};
                otherItems.forEach(item => {
                    // تحديد المجموعة الفرعية بناءً على اسم الصنف
                    let subGroup = 'أخرى';
                    if (item.name && (item.name.includes('حمص') || item.name.includes('متبل'))) {
                        subGroup = 'مقبلات أساسية';
                    } else if (item.name && (item.name.includes('أرز') || item.name.includes('بوري'))) {
                        subGroup = 'أرز وبوري';
                    } else if (item.name && (item.name.includes('صوص') || item.name.includes('صلصة') || item.name.includes('مايونيز') || item.name.includes('كاتشب'))) {
                        subGroup = 'صلصات وبهارات';
                    } else if (item.name && (item.name.includes('لبن') || item.name.includes('لبنة'))) {
                        subGroup = 'مشتقات الحليب';
                    } else if (item.name && item.name.includes('بيض')) {
                        subGroup = 'أصناف متنوعة';
                    }
                    
                    if (!groupedItems[subGroup]) {
                        groupedItems[subGroup] = [];
                    }
                    
                    groupedItems[subGroup].push(item);
                });
                
                // عرض الأصناف المجمعة في جدول
                for (const group in groupedItems) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'inventory-category';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'category-title-orange';
                    titleDiv.textContent = group;
                    categoryDiv.appendChild(titleDiv);
                    
                    const table = document.createElement('table');
                    table.className = 'inventory-table';
                    
                    // رأس الجدول
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>م</th>
                            <th>اسم الصنف</th>
                            <th>الشد</th>
                            <th>الجرد من البرنامج</th>
                            <th class="count-cell">الجرد بالوحدة الصغرى</th>
                            <th>الجرد الفعلي</th>
                            <th class="difference-cell">العجز/الزيادة</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    
                    groupedItems[group].forEach((item, index) => {
                        const row = document.createElement('tr');
                        
                        // تحديد لون الفرق وإضافة كلمة عجز/زيادة
                        const difference = item.difference || 0;
                        const differenceClass = difference < 0 ? 'difference-negative' : 
                                               difference > 0 ? 'difference-positive' : '';
                        const differenceText = difference < 0 ? 'عجز' : 
                                              difference > 0 ? 'زيادة' : '';
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.vendorUOM}</td>
                            <td>${item.stockQty}</td>
                            <td class="count-cell">${item.smallestUnitQty}</td>
                            <td>
                                <input type="number" class="actual-count-input" data-code="${item.code}" 
                                       value="${item.actualCount || ''}" placeholder="0">
                            </td>
                            <td class="difference-cell ${differenceClass}" data-code="${item.code}" style="font-size: 18px; font-weight: bold;">
                                ${difference} ${differenceText ? `<span class="difference-text" style="color: ${differenceClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${differenceText})</span>` : ''}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                        
                        // إضافة مستمع حدث لحساب الفرق
                        const input = row.querySelector('.actual-count-input');
                        input.addEventListener('input', function() {
                            const actualCount = parseFloat(this.value) || 0;
                            const difference = actualCount - item.smallestUnitQty;
                            const differenceText = difference < 0 ? 'عجز' : 
                                                  difference > 0 ? 'زيادة' : '';
                            
                            // تحديث الفرق في الخلية مع التلوين والنص
                            const differenceCell = document.querySelector(`.difference-cell[data-code="${item.code}"]`);
                            differenceCell.innerHTML = `${Math.round(difference)} ${differenceText ? `<span class="difference-text" style="color: ${difference < 0 ? 'var(--accent-red)' : difference > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${differenceText})</span>` : ''}`;
                            
                            // تحديث اللون بناءً على القيمة
                            differenceCell.classList.remove('difference-negative', 'difference-positive');
                            if (difference < 0) {
                                differenceCell.classList.add('difference-negative');
                            } else if (difference > 0) {
                                differenceCell.classList.add('difference-positive');
                            }
                            
                            // تحديث بيانات العنصر
                            item.actualCount = actualCount;
                            item.difference = Math.round(difference);
                            
                            // إعادة حساب المجموع
                            updateGroupTotal(group, groupedItems[group]);
                        });
                    });
                    
                    table.appendChild(tbody);
                    
                    // صف المجموع
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'group-total';
                    const groupTotalValue = groupedItems[group].reduce((sum, item) => sum + (item.difference || 0), 0);
                    const groupTotalClass = groupTotalValue < 0 ? 'difference-negative' : 
                                           groupTotalValue > 0 ? 'difference-positive' : '';
                    const groupTotalText = groupTotalValue < 0 ? 'عجز' : 
                                          groupTotalValue > 0 ? 'زيادة' : '';
                    totalRow.innerHTML = `
                        <td colspan="6">إجمالي ${group}</td>
                        <td class="group-total-cell ${groupTotalClass}" data-group="${group}" style="font-size: 18px; font-weight: bold;">
                            ${groupTotalValue} ${groupTotalText ? `<span class="difference-text" style="color: ${groupTotalClass.includes('negative') ? 'var(--accent-red)' : 'var(--accent-green)'};">(${groupTotalText})</span>` : ''}
                        </td>
                    `;
                    table.appendChild(totalRow);
                    
                    categoryDiv.appendChild(table);
                    container.appendChild(categoryDiv);
                }
            }
        }

        // تحديث المجموع لكل مجموعة
        function updateGroupTotal(group, items) {
            const total = items.reduce((sum, item) => sum + (item.difference || 0), 0);
            const totalCell = document.querySelector(`.group-total-cell[data-group="${group}"]`);
            if (totalCell) {
                const totalText = total < 0 ? 'عجز' : 
                                 total > 0 ? 'زيادة' : '';
                totalCell.innerHTML = `${Math.round(total)} ${totalText ? `<span class="difference-text" style="color: ${total < 0 ? 'var(--accent-red)' : total > 0 ? 'var(--accent-green)' : 'var(--primary)'};">(${totalText})</span>` : ''}`;
                
                // تحديث اللون بناءً على القيمة
                totalCell.classList.remove('difference-negative', 'difference-positive');
                if (total < 0) {
                    totalCell.classList.add('difference-negative');
                } else if (total > 0) {
                    totalCell.classList.add('difference-positive');
                }
            }
        }

        // تحديث جدول المطاعم في قسم الإعدادات
        function updateRestaurantsTable() {
            const tableBody = document.getElementById('restaurants-table-body');
            tableBody.innerHTML = '';
            
            restaurants.forEach(restaurant => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${restaurant.name}</td>
                    <td>${restaurant.areaManager}</td>
                    <td>${restaurant.operationsManager}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // ================= دالة حفظ PDF محسنة مع إصلاحات =================
        async function generatePDF(sectionType) {
            // sectionType: 'meat' أو 'veg' أو 'appetizers'
            
            if (!window.jspdf || !window.html2canvas) {
                showNotification('مكتبات PDF غير محملة. يرجى تحديث الصفحة.');
                return;
            }
            
            try {
                // جمع البيانات بناءً على النوع
                let items = [];
                let restaurantName = '';
                let responsibleName = '';
                let areaManager = '';
                let operationsManager = '';
                let title = '';
                
                if (sectionType === 'meat') {
                    items = selectedItems.filter(item => item.group === 'meat');
                    restaurantName = document.getElementById('meat-restaurant-search').value;
                    responsibleName = document.getElementById('meat-responsible').value;
                    areaManager = document.getElementById('meat-area-manager').textContent;
                    operationsManager = document.getElementById('meat-operations-manager').textContent;
                    title = 'جرد أصناف اللحوم';
                } else if (sectionType === 'veg') {
                    items = selectedItems.filter(item => item.group === 'vegetables');
                    restaurantName = document.getElementById('veg-restaurant-search').value;
                    responsibleName = document.getElementById('veg-responsible').value;
                    areaManager = document.getElementById('veg-area-manager').textContent;
                    operationsManager = document.getElementById('veg-operations-manager').textContent;
                    title = 'جرد أصناف الخضروات';
                } else {
                    items = selectedItems.filter(item => item.group === 'appetizers');
                    restaurantName = document.getElementById('appetizers-restaurant-search').value;
                    responsibleName = document.getElementById('appetizers-responsible').value;
                    areaManager = document.getElementById('appetizers-area-manager').textContent;
                    operationsManager = document.getElementById('appetizers-operations-manager').textContent;
                    title = 'جرد أصناف المقبلات';
                }
                
                if (items.length === 0) {
                    showNotification('لا توجد بيانات للتصدير');
                    return;
                }
                
                // تحضير قالب PDF
                const pdfTemplate = document.getElementById('pdf-template');
                
                // تحديث معلومات المطعم في القالب
                const restaurantInfoDiv = pdfTemplate.querySelector('#pdf-restaurant-info');
                restaurantInfoDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <strong>المطعم:</strong> ${restaurantName || 'غير محدد'}
                        </div>
                        <div>
                            <strong>مسئول المطعم:</strong> ${responsibleName || 'غير محدد'}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>مدير المنطقة:</strong> ${areaManager}
                        </div>
                        <div>
                            <strong>مدير التشغيل:</strong> ${operationsManager}
                        </div>
                    </div>
                `;
                
                // تحديث عنوان التقرير
                const pdfHeader = pdfTemplate.querySelector('.pdf-header');
                const existingTitle = pdfHeader.querySelector('h2');
                if (existingTitle) {
                    existingTitle.textContent = title;
                }
                
                // إنشاء محتوى الجرد
                const pdfContent = pdfTemplate.querySelector('#pdf-content');
                
                // البحث عن الأصناف المتشابهة للجرد اللحوم
                const similarGroups = {};
                if (sectionType === 'meat') {
                    const meatItems = items;
                    meatItems.forEach(item => {
                        let baseName = item.name;
                        
                        if (baseName.includes("Chicken Big Fillet")) {
                            baseName = "Chicken Big Fillet";
                        } else if (baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Grilled")) {
                            baseName = "Chicken Fillet";
                        } else if (baseName.includes("Chicken Finger Fillet") || baseName.includes("Ch.Finger Fillet")) {
                            baseName = "Chicken Finger Fillet";
                        } else if (baseName.includes("Chicken Tikka")) {
                            baseName = "Chicken Tikka";
                        } else if (baseName.includes("Chicken Fried")) {
                            baseName = "Chicken Fried";
                        } else if (baseName.includes("Chicken Small Wings")) {
                            baseName = "Chicken Small Wings";
                        } else if (baseName.includes("Chicken Wings")) {
                            baseName = "Chicken Wings";
                        } else if (baseName.includes("Drumstick whole Fried")) {
                            baseName = "Drumstick whole Fried";
                        } else if (baseName.includes("وصلة دجاج")) {
                            baseName = "وصلة دجاج";
                        } else if (baseName.includes("Chicken Burger") && !baseName.includes("Fresh")) {
                            baseName = "Chicken Burger";
                        } else if (baseName.includes("Beef Burger Big")) {
                            baseName = "Beef Burger Big";
                        } else if (baseName.includes("Beef Burger Small")) {
                            baseName = "Beef Burger Small";
                        } else if (baseName.includes("Fresh Burger Chickens")) {
                            baseName = "Fresh Burger Chickens";
                        }
                        
                        // تجميع فروج نايف مع بنت الديك
                        if (baseName.includes("Rooster Junior") || baseName.includes("Bint Al-Deek") || 
                            item.name.includes("فروج نايف") || item.name.includes("بنت الديك")) {
                            baseName = "فروج/بنت الديك";
                        }
                        
                        // تجميع الفيليه المشوي مع الفيليه العادي والفيليه فلفل
                        if (baseName.includes("Grilled Chicken Fillet") || 
                            baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Big") ||
                            item.name.includes("فيليه مشوي") || item.name.includes("فيليه عادي") || item.name.includes("فيليه فلفل")) {
                            if (!baseName.includes("Finger") && !baseName.includes("Big")) {
                                baseName = "فيليه دجاج";
                            }
                        }
                        
                        if (!similarGroups[baseName]) {
                            similarGroups[baseName] = [];
                        }
                        
                        similarGroups[baseName].push(item);
                    });
                }
                
                // بناء محتوى PDF - عرض جميع الأصناف في جدول واحد بدون فواصل
                let contentHTML = '';
                let totalDifference = 0;
                let processedItems = new Set();
                
                // حساب عدد الأعمدة
                const hasCombinedColumn = sectionType === 'meat' || (sectionType === 'appetizers' && items.some(item => isSaladItem(item)));
                const columnCount = hasCombinedColumn ? 8 : 7;
                
                contentHTML += `
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 5px;">
                        <thead>
                            <tr style="background: #EFF6FF;">
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 4%; font-size: 9px; font-weight: bold;">م</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: right; width: 30%; font-size: 9px; font-weight: bold;">اسم الصنف</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 10%; font-size: 9px; font-weight: bold;">الشد</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 9%; font-size: 9px; font-weight: bold;">جرد البرنامج</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 9%; font-size: 9px; font-weight: bold;">جرد الوحدة الصغرى</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 9%; font-size: 9px; font-weight: bold;">الجرد الفعلي</th>
                                <th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 12%; font-size: 9px; font-weight: bold;">العجز/الزيادة</th>
                                ${hasCombinedColumn ? '<th style="border: 1px solid #ddd; padding: 2px; text-align: center; width: 12%; font-size: 9px; font-weight: bold;">الفروقات المجمعة</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let rowIndex = 0;
                
                // عرض الأصناف
                items.forEach((item, index) => {
                    // تخطي العناصر التي تمت معالجتها بالفعل في مجموعة متشابهة
                    if (processedItems.has(item.code)) {
                        return;
                    }
                    
                    // البحث عما إذا كان هذا العنصر جزءًا من مجموعة متشابهة (لجرد اللحوم فقط)
                    let similarItems = [];
                    let isPartOfSimilarGroup = false;
                    
                    if (sectionType === 'meat') {
                        for (const baseName in similarGroups) {
                            const groupItems = similarGroups[baseName];
                            const similarItem = groupItems.find(i => i.code === item.code);
                            if (similarItem && groupItems.length > 1) {
                                similarItems = groupItems;
                                isPartOfSimilarGroup = true;
                                break;
                            }
                        }
                    } else if (sectionType === 'appetizers' && isSaladItem(item)) {
                        // تجميع كل السلطات معًا
                        similarItems = items.filter(i => isSaladItem(i));
                        isPartOfSimilarGroup = true;
                    }
                    
                    if (isPartOfSimilarGroup && similarItems.length > 0) {
                        // عرض جميع العناصر المتشابهة معًا
                        similarItems.forEach((similarItem, similarIndex) => {
                            // تخطي إذا تمت معالجته بالفعل
                            if (processedItems.has(similarItem.code)) {
                                return;
                            }
                            
                            const difference = similarItem.difference || 0;
                            const differenceText = difference < 0 ? 'عجز' : 
                                                  difference > 0 ? 'زيادة' : '';
                            
                            // إذا كان هذا هو الصف الأول في المجموعة المتشابهة، أضف الخلية المجمعة
                            let combinedCellHTML = '';
                            if (similarIndex === 0) {
                                const combinedDifference = similarItems.reduce((sum, i) => sum + (i.difference || 0), 0);
                                const combinedText = combinedDifference < 0 ? 'عجز' : 
                                                    combinedDifference > 0 ? 'زيادة' : 'متساوي';
                                combinedCellHTML = `
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 8.5px; font-weight: bold; color: ${combinedDifference < 0 ? 'red' : combinedDifference > 0 ? 'green' : '#333'}; vertical-align: middle;" rowspan="${similarItems.length}">
                                        <span style="display: block; margin-bottom: 1px;">${combinedDifference}</span>
                                        <span style="display: block; font-size: 7.6px; opacity: 0.9;">${combinedText}</span>
                                    </td>
                                `;
                            }
                            
                            contentHTML += `
                                <tr style="height: 18px;">
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${rowIndex + 1}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: right; font-size: 9px; vertical-align: middle;">${similarItem.name}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${similarItem.vendorUOM}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${similarItem.stockQty}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; vertical-align: middle;">${similarItem.smallestUnitQty}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; vertical-align: middle;">${similarItem.actualCount || 0}</td>
                                    <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; color: ${difference < 0 ? 'red' : difference > 0 ? 'green' : '#333'}; vertical-align: middle;">
                                        <span style="display: block; margin-bottom: 1px;">${difference}</span>
                                        <span style="display: block; font-size: 8px; opacity: 0.9;">${differenceText || ''}</span>
                                    </td>
                                    ${similarIndex === 0 ? combinedCellHTML : ''}
                                </tr>
                            `;
                            
                            processedItems.add(similarItem.code);
                            totalDifference += difference;
                            rowIndex++;
                        });
                    } else {
                        // عرض العنصر العادي
                        const difference = item.difference || 0;
                        const differenceText = difference < 0 ? 'عجز' : 
                                              difference > 0 ? 'زيادة' : '';
                        
                        let combinedCellHTML = '';
                        if (hasCombinedColumn && !isSaladItem(item)) {
                            combinedCellHTML = `
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 8.5px; font-weight: bold; color: ${difference < 0 ? 'red' : difference > 0 ? 'green' : '#333'}; vertical-align: middle;">
                                    <span style="display: block; margin-bottom: 1px;">${difference}</span>
                                    <span style="display: block; font-size: 7.6px; opacity: 0.9;">${differenceText || 'متساوي'}</span>
                                </td>
                            `;
                        }
                        
                        contentHTML += `
                            <tr style="height: 18px;">
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${rowIndex + 1}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: right; font-size: 9px; vertical-align: middle;">${item.name}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${item.vendorUOM}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; vertical-align: middle;">${item.stockQty}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; vertical-align: middle;">${item.smallestUnitQty}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; vertical-align: middle;">${item.actualCount || 0}</td>
                                <td style="border: 1px solid #ddd; padding: 1px; text-align: center; font-size: 9px; font-weight: bold; color: ${difference < 0 ? 'red' : difference > 0 ? 'green' : '#333'}; vertical-align: middle;">
                                    <span style="display: block; margin-bottom: 1px;">${difference}</span>
                                    <span style="display: block; font-size: 8px; opacity: 0.9;">${differenceText || ''}</span>
                                </td>
                                ${combinedCellHTML}
                            </tr>
                        `;
                        
                        processedItems.add(item.code);
                        totalDifference += difference;
                        rowIndex++;
                    }
                });
                
                contentHTML += `
                        </tbody>
                    </table>
                `;
                
                // إضافة الإجمالي الكلي
                contentHTML += `
                    <div style="margin-top: 10px; padding: 8px; background: #EFF6FF; border-radius: 4px; text-align: center; font-weight: bold; border: 1px solid var(--primary);">
                        <div style="font-size: 10px;">الإجمالي الكلي: 
                            <span style="color: ${totalDifference < 0 ? 'red' : totalDifference > 0 ? 'green' : 'var(--primary)'}; font-size: 12px; font-weight: bold;">
                                ${totalDifference} ${totalDifference < 0 ? '(عجز)' : totalDifference > 0 ? '(زيادة)' : ''}
                            </span>
                        </div>
                        <div style="font-size: 9px; margin-top: 3px; color: #666;">
                            (عدد الأصناف: ${items.length} صنف)
                        </div>
                    </div>
                `;
                
                pdfContent.innerHTML = contentHTML;
                
                // تحديث تاريخ الطباعة
                const now = new Date();
                const printDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                document.getElementById('pdf-print-date').textContent = printDate;
                
                // إظهار العنصر مؤقتاً لالتقاط الصورة
                const originalDisplay = pdfTemplate.style.display;
                const originalPosition = pdfTemplate.style.position;
                const originalLeft = pdfTemplate.style.left;
                const originalTop = pdfTemplate.style.top;
                const originalZIndex = pdfTemplate.style.zIndex;
                
                pdfTemplate.style.display = 'block';
                pdfTemplate.style.position = 'fixed';
                pdfTemplate.style.left = '0';
                pdfTemplate.style.top = '0';
                pdfTemplate.style.zIndex = '10000';
                pdfTemplate.style.background = 'white';
                
                // الانتظار قليلاً لتحميل الصورة
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // استخدام html2canvas لالتقاط الصورة
                const canvas = await html2canvas(pdfTemplate, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#FFFFFF',
                    width: 794,
                    height: 1123,
                    windowWidth: 794,
                    windowHeight: 1123
                });
                
                // إعادة العنصر إلى وضعه الأصلي
                pdfTemplate.style.display = originalDisplay;
                pdfTemplate.style.position = originalPosition;
                pdfTemplate.style.left = originalLeft;
                pdfTemplate.style.top = originalTop;
                pdfTemplate.style.zIndex = originalZIndex;
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new window.jspdf.jsPDF('p', 'pt', 'a4');
                
                const imgWidth = pdf.internal.pageSize.getWidth();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // إضافة الصورة إلى PDF
                pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                
                // تنظيف اسم الملف
                const cleanRestaurantName = restaurantName.replace(/[^\w\u0600-\u06FF\s]/g, '') || 'غير-محدد';
                const cleanType = sectionType === 'meat' ? 'اللحوم' : sectionType === 'veg' ? 'الخضروات' : 'المقبلات';
                const fileName = `جرد_${cleanType}_${cleanRestaurantName}.pdf`;
                
                // حفظ ملف PDF
                pdf.save(fileName);
                
                showNotification('تم إنشاء ملف PDF بنجاح!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('حدث خطأ أثناء إنشاء ملف PDF: ' + error.message);
            }
        }

        // تصدير إلى PDF (لجرد اللحوم)
        document.getElementById('generate-meat-pdf').addEventListener('click', function() {
            generatePDF('meat');
        });

        // تصدير إلى PDF (لجرد الخضروات)
        document.getElementById('generate-veg-pdf').addEventListener('click', function() {
            generatePDF('veg');
        });

        // تصدير إلى PDF (لجرد المقبلات)
        document.getElementById('generate-appetizers-pdf').addEventListener('click', function() {
            generatePDF('appetizers');
        });

        // تصدير إلى Excel مع تنسيق محسن
        function generateExcel(sectionType, buttonId) {
            let items = [];
            let restaurantName = '';
            let responsibleName = '';
            let title = '';
            let fileName = '';
            
            if (sectionType === 'meat') {
                items = selectedItems.filter(item => item.group === 'meat');
                restaurantName = document.getElementById('meat-restaurant-search').value;
                responsibleName = document.getElementById('meat-responsible').value;
                title = 'جرد أصناف اللحوم';
                fileName = 'جرد_اللحوم.xlsx';
            } else if (sectionType === 'veg') {
                items = selectedItems.filter(item => item.group === 'vegetables');
                restaurantName = document.getElementById('veg-restaurant-search').value;
                responsibleName = document.getElementById('veg-responsible').value;
                title = 'جرد أصناف الخضروات';
                fileName = 'جرد_الخضروات.xlsx';
            } else {
                items = selectedItems.filter(item => item.group === 'appetizers');
                restaurantName = document.getElementById('appetizers-restaurant-search').value;
                responsibleName = document.getElementById('appetizers-responsible').value;
                title = 'جرد أصناف المقبلات';
                fileName = 'جرد_المقبلات.xlsx';
            }
            
            if (items.length === 0) {
                showNotification('لا توجد بيانات للتصدير');
                return;
            }
            
            // تحويل البيانات إلى تنسيق Excel مع تنسيق محسن
            const data = [];
            
            // العنوان الرئيسي
            data.push([title]);
            data.push([]);
            data.push([`المطعم: ${restaurantName || 'غير محدد'}`]);
            data.push([`المسئول: ${responsibleName || 'غير محدد'}`]);
            data.push([`تاريخ الإصدار: ${new Date().toLocaleDateString('ar-SA')}`]);
            data.push([]);
            
            // البحث عن الأصناف المتشابهة للجرد اللحوم
            const similarGroups = {};
            if (sectionType === 'meat') {
                items.forEach(item => {
                    let baseName = item.name;
                    
                    if (baseName.includes("Chicken Big Fillet")) {
                        baseName = "Chicken Big Fillet";
                    } else if (baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Grilled")) {
                        baseName = "Chicken Fillet";
                    } else if (baseName.includes("Chicken Finger Fillet") || baseName.includes("Ch.Finger Fillet")) {
                        baseName = "Chicken Finger Fillet";
                    } else if (baseName.includes("Chicken Tikka")) {
                        baseName = "Chicken Tikka";
                    } else if (baseName.includes("Chicken Fried")) {
                        baseName = "Chicken Fried";
                    } else if (baseName.includes("Chicken Small Wings")) {
                        baseName = "Chicken Small Wings";
                    } else if (baseName.includes("Chicken Wings")) {
                        baseName = "Chicken Wings";
                    } else if (baseName.includes("Drumstick whole Fried")) {
                        baseName = "Drumstick whole Fried";
                    } else if (baseName.includes("وصلة دجاج")) {
                        baseName = "وصلة دجاج";
                    } else if (baseName.includes("Chicken Burger") && !baseName.includes("Fresh")) {
                        baseName = "Chicken Burger";
                    } else if (baseName.includes("Beef Burger Big")) {
                        baseName = "Beef Burger Big";
                    } else if (baseName.includes("Beef Burger Small")) {
                        baseName = "Beef Burger Small";
                    } else if (baseName.includes("Fresh Burger Chickens")) {
                        baseName = "Fresh Burger Chickens";
                    }
                    
                    // تجميع فروج نايف مع بنت الديك
                    if (baseName.includes("Rooster Junior") || baseName.includes("Bint Al-Deek") || 
                        item.name.includes("فروج نايف") || item.name.includes("بنت الديك")) {
                        baseName = "فروج/بنت الديك";
                    }
                    
                    // تجميع الفيليه المشوي مع الفيليه العادي والفيليه فلفل
                    if (baseName.includes("Grilled Chicken Fillet") || 
                        baseName.includes("Chicken Fillet") && !baseName.includes("Finger") && !baseName.includes("Big") ||
                        item.name.includes("فيليه مشوي") || item.name.includes("فيليه عادي") || item.name.includes("فيليه فلفل")) {
                        if (!baseName.includes("Finger") && !baseName.includes("Big")) {
                            baseName = "فيليه دجاج";
                        }
                    }
                    
                    if (!similarGroups[baseName]) {
                        similarGroups[baseName] = [];
                    }
                    
                    similarGroups[baseName].push(item);
                });
            }
            
            // إضافة البيانات
            data.push(['م', 'اسم الصنف', 'الشد', 'الجرد من البرنامج', 'الجرد بالوحدة الصغرى', 'الجرد الفعلي', 'العجز/الزيادة', 'الفروقات المجمعة']);
            
            let processedItems = new Set();
            let rowIndex = 0;
            
            items.forEach((item) => {
                // تخطي العناصر التي تمت معالجتها بالفعل في مجموعة متشابهة
                if (processedItems.has(item.code)) {
                    return;
                }
                
                // البحث عما إذا كان هذا العنصر جزءًا من مجموعة متشابهة (لجرد اللحوم فقط)
                let similarItems = [];
                let isPartOfSimilarGroup = false;
                
                if (sectionType === 'meat') {
                    for (const baseName in similarGroups) {
                        const groupItems = similarGroups[baseName];
                        const similarItem = groupItems.find(i => i.code === item.code);
                        if (similarItem && groupItems.length > 1) {
                            similarItems = groupItems;
                            isPartOfSimilarGroup = true;
                            break;
                        }
                    }
                } else if (sectionType === 'appetizers' && isSaladItem(item)) {
                    // تجميع كل السلطات معًا
                    similarItems = items.filter(i => isSaladItem(i));
                    isPartOfSimilarGroup = true;
                }
                
                if (isPartOfSimilarGroup && similarItems.length > 0) {
                    // عرض جميع العناصر المتشابهة معًا
                    similarItems.forEach((similarItem, similarIndex) => {
                        if (processedItems.has(similarItem.code)) {
                            return;
                        }
                        
                        const differenceText = similarItem.difference < 0 ? 'عجز' : 
                                              similarItem.difference > 0 ? 'زيادة' : '';
                        
                        let combinedValue = '';
                        if (similarIndex === 0) {
                            const combinedDifference = similarItems.reduce((sum, i) => sum + (i.difference || 0), 0);
                            const combinedText = combinedDifference < 0 ? 'عجز' : 
                                                combinedDifference > 0 ? 'زيادة' : 'متساوي';
                            combinedValue = `${combinedDifference} (${combinedText})`;
                        }
                        
                        data.push([
                            rowIndex + 1,
                            similarItem.name,
                            similarItem.vendorUOM,
                            similarItem.stockQty,
                            similarItem.smallestUnitQty,
                            similarItem.actualCount || 0,
                            `${similarItem.difference || 0} ${differenceText ? `(${differenceText})` : ''}`,
                            similarIndex === 0 ? combinedValue : ''
                        ]);
                        
                        processedItems.add(similarItem.code);
                        rowIndex++;
                    });
                } else {
                    // عرض العنصر العادي
                    const differenceText = item.difference < 0 ? 'عجز' : 
                                          item.difference > 0 ? 'زيادة' : '';
                    
                    data.push([
                        rowIndex + 1,
                        item.name,
                        item.vendorUOM,
                        item.stockQty,
                        item.smallestUnitQty,
                        item.actualCount || 0,
                        `${item.difference || 0} ${differenceText ? `(${differenceText})` : ''}`,
                        `${item.difference || 0} ${differenceText ? `(${differenceText})` : ''}`
                    ]);
                    
                    processedItems.add(item.code);
                    rowIndex++;
                }
            });
            
            // إنشاء ورقة عمل مع تنسيق
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تحديد عرض الأعمدة
            const wscols = [
                { wch: 5 },   // العمود الأول: م
                { wch: 35 },  // العمود الثاني: اسم الصنف
                { wch: 12 },  // العمود الثالث: الشد (تم زيادته 25%)
                { wch: 15 },  // العمود الرابع: الجرد من البرنامج
                { wch: 18 },  // العمود الخامس: الجرد بالوحدة الصغرى
                { wch: 15 },  // العمود السادس: الجرد الفعلي
                { wch: 18 },  // العمود السابع: العجز/الزيادة
                { wch: 18 }   // العمود الثامن: الفروقات المجمعة
            ];
            ws['!cols'] = wscols;
            
            // إنشاء مصنف وإضافة الورقة
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, title.substring(0, 31)); // تقليل العنوان ليتناسب مع اسم الورقة
            
            // تصدير الملف
            XLSX.writeFile(wb, fileName);
            
            showNotification('تم تصدير ملف Excel بنجاح!');
        }

        // تصدير إلى Excel (لجرد اللحوم)
        document.getElementById('generate-meat-excel').addEventListener('click', function() {
            generateExcel('meat', 'generate-meat-excel');
        });

        // تصدير إلى Excel (لجرد الخضروات)
        document.getElementById('generate-veg-excel').addEventListener('click', function() {
            generateExcel('veg', 'generate-veg-excel');
        });

        // تصدير إلى Excel (لجرد المقبلات)
        document.getElementById('generate-appetizers-excel').addEventListener('click', function() {
            generateExcel('appetizers', 'generate-appetizers-excel');
        });

        // إرسال إلى واتساب (لجرد اللحوم)
        document.getElementById('send-meat-whatsapp').addEventListener('click', function() {
            currentWhatsappType = 'meat';
            document.getElementById('whatsapp-modal').style.display = 'flex';
            // إعادة تعيين ملف الإرفاق
            whatsappAttachmentFile = null;
            document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
        });

        // إرسال إلى واتساب (لجرد الخضروات)
        document.getElementById('send-veg-whatsapp').addEventListener('click', function() {
            currentWhatsappType = 'veg';
            document.getElementById('whatsapp-modal').style.display = 'flex';
            // إعادة تعيين ملف الإرفاق
            whatsappAttachmentFile = null;
            document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
        });

        // إرسال إلى واتساب (لجرد المقبلات)
        document.getElementById('send-appetizers-whatsapp').addEventListener('click', function() {
            currentWhatsappType = 'appetizers';
            document.getElementById('whatsapp-modal').style.display = 'flex';
            // إعادة تعيين ملف الإرفاق
            whatsappAttachmentFile = null;
            document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
        });

        // اختيار ملف للإرفاق
        document.getElementById('whatsapp-attachment').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                whatsappAttachmentFile = file;
                document.getElementById('attachment-name').textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
            } else {
                whatsappAttachmentFile = null;
                document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
            }
        });

        // تأكيد إرسال الواتساب
        document.getElementById('confirm-whatsapp-send').addEventListener('click', function() {
            const phoneNumber = document.getElementById('whatsapp-number').value.replace(/\s+/g, '');
            if (!phoneNumber) {
                showNotification('يرجى إدخال رقم الهاتف');
                return;
            }
            
            let message = '';
            let items = [];
            
            if (currentWhatsappType === 'meat') {
                const responsible = document.getElementById('meat-responsible').value || 'غير محدد';
                const restaurantInput = document.getElementById('meat-restaurant-search');
                const restaurant = restaurantInput.value || 'غير محدد';
                
                message = `جرد أصناف اللحوم\n`;
                message += `المطعم: ${restaurant}\n`;
                message += `المسئول: ${responsible}\n\n`;
                
                items = selectedItems.filter(item => 
                    item.group === 'meat'
                );
            } else if (currentWhatsappType === 'veg') {
                const responsible = document.getElementById('veg-responsible').value || 'غير محدد';
                const restaurantInput = document.getElementById('veg-restaurant-search');
                const restaurant = restaurantInput.value || 'غير محدد';
                
                message = `جرد أصناف الخضروات\n`;
                message += `المطعم: ${restaurant}\n`;
                message += `المسئول: ${responsible}\n\n`;
                
                items = selectedItems.filter(item => 
                    item.group === 'vegetables'
                );
            } else {
                const responsible = document.getElementById('appetizers-responsible').value || 'غير محدد';
                const restaurantInput = document.getElementById('appetizers-restaurant-search');
                const restaurant = restaurantInput.value || 'غير محدد';
                
                message = `جرد أصناف المقبلات\n`;
                message += `المطعم: ${restaurant}\n`;
                message += `المسئول: ${responsible}\n\n`;
                
                items = selectedItems.filter(item => 
                    item.group === 'appetizers'
                );
            }
            
            if (items.length === 0) {
                showNotification('لا توجد بيانات للإرسال');
                return;
            }
            
            // إضافة بيانات الجرد
            items.forEach(item => {
                const differenceText = item.difference < 0 ? 'عجز' : 
                                      item.difference > 0 ? 'زيادة' : '';
                message += `${item.name}: ${item.actualCount || 0} (الفرق: ${item.difference || 0} ${differenceText})\n`;
            });
            
            // إضافة ملخص
            const totalDifference = items.reduce((sum, item) => sum + (item.difference || 0), 0);
            const totalDifferenceText = totalDifference < 0 ? 'عجز' : 
                                       totalDifference > 0 ? 'زيادة' : '';
            message += `\nالإجمالي الكلي: ${totalDifference} ${totalDifferenceText}`;
            message += `\nعدد الأصناف: ${items.length}`;
            
            const encodedMessage = encodeURIComponent(message);
            let whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // فتح نافذة الواتساب
            window.open(whatsappURL, '_blank');
            
            // إغلاق النافذة
            document.getElementById('whatsapp-modal').style.display = 'none';
            document.getElementById('whatsapp-number').value = '+96567011143';
            
            showNotification('تم فتح تطبيق الواتساب لإرسال الرسالة');
        });

        // إلغاء إرسال الواتساب
        document.getElementById('cancel-whatsapp-send').addEventListener('click', function() {
            document.getElementById('whatsapp-modal').style.display = 'none';
            document.getElementById('whatsapp-number').value = '+96567011143';
            whatsappAttachmentFile = null;
            document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
        });

        // إظهار الإشعارات
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // البحث عن المطاعم
        function searchRestaurants(query) {
            const resultsDiv = document.getElementById('restaurant-search-results');
            resultsDiv.innerHTML = '';
            
            const filteredRestaurants = restaurants.filter(restaurant => 
                restaurant.name.includes(query)
            );
            
            if (filteredRestaurants.length === 0) {
                resultsDiv.innerHTML = '<p>لا توجد نتائج</p>';
                return;
            }
            
            filteredRestaurants.forEach(restaurant => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.borderBottom = '1px solid #ddd';
                div.style.cursor = 'pointer';
                div.style.backgroundColor = '#EFF6FF';
                div.style.marginBottom = '5px';
                div.style.borderRadius = '4px';
                div.style.border = '1px solid var(--primary)';
                
                div.innerHTML = `
                    <div style="font-weight: bold; color: var(--primary);">${restaurant.name}</div>
                    <div style="font-size: 12px; color: #666;">مدير المنطقة: ${restaurant.areaManager}</div>
                    <div style="font-size: 12px; color: #666;">مدير التشغيل: ${restaurant.operationsManager}</div>
                `;
                
                div.addEventListener('click', function() {
                    document.getElementById('restaurant-search-modal').style.display = 'none';
                    document.getElementById('restaurant-search-box').value = '';
                    
                    // تعبئة بيانات المطعم المحدد
                    if (currentEditRestaurant) {
                        currentEditRestaurant.name = restaurant.name;
                        currentEditRestaurant.areaManager = restaurant.areaManager;
                        currentEditRestaurant.operationsManager = restaurant.operationsManager;
                        
                        updateRestaurantsTable();
                        showNotification('تم تعديل المطعم بنجاح!');
                    }
                });
                
                resultsDiv.appendChild(div);
            });
        }

        let currentEditRestaurant = null;

        // إضافة مطعم جديد
        document.getElementById('add-restaurant').addEventListener('click', function() {
            const name = prompt('أدخل اسم المطعم الجديد:');
            if (name) {
                const areaManagerOptions = [...new Set(restaurants.map(r => r.areaManager))];
                const operationsManagerOptions = [...new Set(restaurants.map(r => r.operationsManager))];
                
                let areaManager = prompt(`أدخل اسم مدير المنطقة (الخيارات: ${areaManagerOptions.join(', ')}):`);
                let operationsManager = prompt(`أدخل اسم مدير التشغيل (الخيارات: ${operationsManagerOptions.join(', ')}):`);
                
                if (areaManager && operationsManager) {
                    restaurants.push({
                        name: name,
                        areaManager: areaManager,
                        operationsManager: operationsManager
                    });
                    
                    updateRestaurantsTable();
                    showNotification('تم إضافة المطعم بنجاح!');
                }
            }
        });

        // تعديل مطعم
        document.getElementById('edit-restaurant').addEventListener('click', function() {
            document.getElementById('restaurant-search-modal').style.display = 'flex';
            document.getElementById('restaurant-search-box').value = '';
            document.getElementById('restaurant-search-results').innerHTML = '';
            
            // إضافة مستمع للبحث
            document.getElementById('restaurant-search-box').addEventListener('input', function() {
                searchRestaurants(this.value);
            });
            
            currentEditRestaurant = null;
        });

        // حذف مطعم
        document.getElementById('delete-restaurant').addEventListener('click', function() {
            const name = prompt('أدخل اسم المطعم الذي تريد حذفه:');
            if (name) {
                const index = restaurants.findIndex(r => r.name === name);
                if (index !== -1) {
                    if (confirm(`هل أنت متأكد من حذف مطعم ${name}؟`)) {
                        restaurants.splice(index, 1);
                        updateRestaurantsTable();
                        showNotification('تم حذف المطعم بنجاح!');
                    }
                } else {
                    showNotification('لم يتم العثور على المطعم');
                }
            }
        });

        // إغلاق نافذة الحركة
        document.getElementById('close-movement-modal').addEventListener('click', function() {
            document.getElementById('movement-modal').style.display = 'none';
        });

        // إغلاق نافذة الواتساب
        document.getElementById('close-whatsapp-modal').addEventListener('click', function() {
            document.getElementById('whatsapp-modal').style.display = 'none';
            document.getElementById('whatsapp-number').value = '+96567011143';
            whatsappAttachmentFile = null;
            document.getElementById('attachment-name').textContent = 'لم يتم اختيار ملف';
        });

        // إغلاق نافذة البحث عن المطعم
        document.getElementById('close-restaurant-search-modal').addEventListener('click', function() {
            document.getElementById('restaurant-search-modal').style.display = 'none';
            document.getElementById('restaurant-search-box').value = '';
        });

        // تهيئة التطبيق عند التحميل
        window.addEventListener('DOMContentLoaded', function() {
            updateStats();
            updateRestaurantsTable();
            
            // إعداد البحث الديناميكي للمطاعم
            setupRestaurantAutocomplete('meat-restaurant-search', 'meat-restaurant-suggestions', {
                restaurantName: 'meat-restaurant-name',
                areaManager: 'meat-area-manager',
                operationsManager: 'meat-operations-manager'
            });
            
            setupRestaurantAutocomplete('veg-restaurant-search', 'veg-restaurant-suggestions', {
                restaurantName: 'veg-restaurant-name',
                areaManager: 'veg-area-manager',
                operationsManager: 'veg-operations-manager'
            });
            
            setupRestaurantAutocomplete('appetizers-restaurant-search', 'appetizers-restaurant-suggestions', {
                restaurantName: 'appetizers-restaurant-name',
                areaManager: 'appetizers-area-manager',
                operationsManager: 'appetizers-operations-manager'
            });
        });
    </script>
</body>
</html>
